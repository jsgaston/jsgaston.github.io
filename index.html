<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Diario Personal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Leaflet CSS para el mapa -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoCcTIDF08/YDKWlQyKgYdFlVEU5SCYgIKgLNTg="
     crossorigin=""/>
    <style>
        /* Fuente Inter para un aspecto moderno y limpio */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Un gris claro para el fondo */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px; /* Ancho mayor para la sección de mapas */
            width: 100%;
            background-color: #ffffff;
            padding: 32px;
            border-radius: 12px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.08);
        }
        .form-label {
            font-weight: 600;
            margin-bottom: 8px;
            display: block;
            color: #374151;
        }
        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 1rem;
            color: #1f2937;
            background-color: #f9fafb;
            transition: border-color 0.2s;
        }
        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: #3b82f6; /* Un azul bonito al enfocar */
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25);
        }
        .btn {
            background-color: #4f46e5; /* Morado intenso */
            color: white;
            padding: 14px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .btn:hover {
            background-color: #4338ca; /* Morado más oscuro al pasar el ratón */
            transform: translateY(-1px);
        }
        .btn:active {
            transform: translateY(0);
        }
        .message-box {
            padding: 12px 20px;
            border-radius: 8px;
            margin-top: 20px;
            font-weight: 500;
            display: none; /* Oculto por defecto */
        }
        .message-box.success {
            background-color: #d1fae5; /* Verde claro */
            color: #065f46; /* Verde oscuro */
            border: 1px solid #10b981;
        }
        .message-box.error {
            background-color: #fee2e2; /* Rojo claro */
            color: #991b1b; /* Rojo oscuro */
            border: 1px solid #ef4444;
        }
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #ffffff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: none; /* Oculto por defecto */
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Estilos para las pestañas de navegación principal */
        .main-tab-button {
            padding: 12px 20px;
            border-radius: 8px 8px 0 0;
            font-weight: 600;
            cursor: pointer;
            background-color: #e5e7eb; /* Gris claro */
            color: #4b5563;
            transition: background-color 0.2s, color 0.2s;
            white-space: nowrap; /* Evita que el texto se rompa */
        }
        .main-tab-button.active {
            background-color: #ffffff;
            color: #4f46e5; /* Morado */
            box-shadow: 0 -2px 0 0 #4f46e5 inset; /* Subrayado morado */
        }
        .main-tab-content {
            padding-top: 24px;
            border-top: 1px solid #e5e7eb;
        }

        /* Estilos para las sub-pestañas del diario */
        .diary-sub-tab-button {
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            background-color: #f3f4f6;
            color: #6b7280;
            transition: background-color 0.2s, color 0.2s;
            margin-right: 8px; /* Espacio entre botones */
        }
        .diary-sub-tab-button.active {
            background-color: #e0e7ff; /* Azul claro */
            color: #4f46e5; /* Morado */
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .diary-sub-tab-content {
            padding-top: 16px;
        }

        .hidden {
            display: none !important;
        }
        .entry-card {
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .entry-card img {
            max-width: 100%;
            height: auto;
            border-radius: 6px;
            margin-top: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.2s;
        }
        .entry-card img:hover {
            transform: scale(1.02);
        }
        
        /* Estilos para el modal de imagen */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
        }
        .modal-content {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            padding: 20px;
        }
        .modal-image {
            max-width: 90%;
            max-height: 90%;
            border-radius: 8px;
        }
        .close-modal {
            position: absolute;
            top: 20px;
            right: 30px;
            color: white;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-modal:hover {
            color: #ccc;
        }
        
        /* Indicador de carga para imágenes */
        .image-loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #4f46e5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }

        /* Estilos para la sección de Mapas de Recorridos */
        #mapid {
            height: 500px; /* Altura fija para el mapa */
            width: 100%;
            border-radius: 0.5rem; /* Bordes redondeados con Tailwind */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            margin-bottom: 24px;
        }
        /* Estilos para la tabla de datos biométricos y de actividad */
        .data-table-container {
            overflow-x: auto;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .data-table {
            min-width: 100%;
            border-collapse: collapse;
            background-color: #ffffff;
        }
        .data-table th, .data-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        .data-table th {
            background-color: #f8fafc;
            font-weight: 600;
            color: #4a5568;
            white-space: nowrap;
        }
        .data-table tr:hover {
            background-color: #edf2f7;
        }
        .data-table .anomaly-row {
            background-color: #fef2f2; /* Fondo rojo claro */
            border-left: 4px solid #ef4444; /* Borde izquierdo rojo */
            font-weight: 500;
        }
        .data-table .anomaly-text {
            color: #dc2626; /* Rojo brillante para el texto de anomalía */
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-gray-100 p-5 flex items-center justify-center min-h-screen">
    <!-- Modal para ver imágenes en grande -->
    <div id="imageModal" class="modal">
        <span class="close-modal">&times;</span>
        <div class="modal-content">
            <img id="modalImage" class="modal-image" src="" alt="Imagen ampliada">
        </div>
    </div>

    <div class="container rounded-xl shadow-xl flex flex-col">
        <h1 class="text-4xl font-extrabold text-gray-900 mb-8 text-center">Javier Santiago Gastón de Iriarte Cabrera 47033535F</h1>

        <nav class="flex border-b border-gray-200 -mt-8 mb-8 overflow-x-auto">
            <button class="main-tab-button active" data-main-tab="home">Inicio</button>
            <button class="main-tab-button" data-main-tab="diary">Diario</button>
            <button class="main-tab-button" data-main-tab="maps">Mapas de Recorridos</button>
            <button class="main-tab-button" data-main-tab="trips">Organizar Viajes</button>
            <button class="main-tab-button" data-main-tab="menus">Menús de Comida</button>
            <button class="main-tab-button" data-main-tab="projects">Proyectos</button>
        </nav>

        <div id="mainHomeSection" class="main-tab-content">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Bienvenido a tu página Personal</h2>
            <p class="text-center text-gray-600 mb-8">Aquí puedes organizar tu vida digital. Explora las pestañas de arriba.</p>
            
            <h3 class="text-xl font-semibold text-gray-700 mb-4">Última Entrada del Diario:</h3>
            <div id="latestEntryContent" class="text-gray-700">
                <p class="text-center text-gray-500">Cargando última entrada del diario...</p>
            </div>
            <div class="flex justify-center mt-8">
                <button onclick="showMainTab('diary'); showDiarySubTab('write')" class="btn py-3 px-6 rounded-lg text-lg">
                    <span>Ir al Diario</span>
                </button>
            </div>
        </div>

        <div id="mainDiarySection" class="main-tab-content hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Mi Diario Digital</h2>
            
            <nav class="flex border-b border-gray-200 mb-6">
                <button class="diary-sub-tab-button active" data-diary-sub-tab="write">Escribir Entrada</button>
                <button class="diary-sub-tab-button" data-diary-sub-tab="view">Ver/Buscar Entradas</button>
            </nav>

            <div id="diaryWriteEntrySection" class="diary-sub-tab-content">
                <form id="diaryForm" class="w-full">
                    <div class="mb-6">
                        <label for="text" class="form-label mb-2">Tu Entrada de Hoy:</label>
                        <textarea id="text" name="text" rows="8" class="form-textarea rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="¿Qué te ha pasado hoy? Escribe aquí tu historia..."></textarea>
                    </div>

                    <div class="mb-4">
                        <label for="photoUpload" class="form-label mb-2">Adjuntar Foto (desde tu ordenador):</label>
                        <input type="file" id="photoUpload" name="photoUpload" accept="image/*" class="form-input rounded-lg file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100">
                        <p class="text-sm text-gray-500 mt-1">Se subirá a tu Google Drive.</p>
                    </div>

                    <div class="mb-8">
                        <label for="externalImageUrl" class="form-label mb-2">O pegar URL de imagen (desde otra web por ejemplo: https://es.imgbb.com/):</label>
                        <input type="url" id="externalImageUrl" name="externalImageUrl" class="form-input rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Ej: https://ibb.co/ABC123 o https://i.imgur.com/ejemplo.jpg">
                        <p class="text-sm text-gray-500 mt-1">Soporta ImgBB, Imgur, PostImage y URLs directas. Se procesará automáticamente.</p>
                    </div>

                    <button type="submit" class="btn w-full">
                        <span id="buttonText">Guardar Entrada</span>
                        <div id="loadingSpinner" class="loading-spinner"></div>
                    </button>
                </form>
            </div>

            <div id="diaryViewSearchSection" class="diary-sub-tab-content hidden">
                <h3 class="text-xl font-semibold text-gray-700 mb-4">Buscar Entradas por Fecha</h3>
                <div class="flex flex-col sm:flex-row items-center justify-center gap-4 mb-8">
                    <div>
                        <label for="startDate" class="form-label">Desde:</label>
                        <input type="date" id="startDate" class="form-input w-auto">
                    </div>
                    <div>
                        <label for="endDate" class="form-label">Hasta:</label>
                        <input type="date" id="endDate" class="form-input w-auto">
                    </div>
                    <button id="searchEntriesBtn" class="btn mt-6 sm:mt-0 px-6 py-3">Buscar</button>
                </div>
                <div id="searchResults" class="text-gray-700">
                    <p class="text-center text-gray-500">Usa el filtro de fechas para buscar entradas.</p>
                </div>
            </div>
        </div>

        <div id="mainMapsSection" class="main-tab-content hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Mapas de Recorridos y Datos Biomédicos</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <!-- Filtros para los datos de mapas/biométricos -->
                <div>
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">Filtros de Datos de Recorrido</h3>
                    <div class="flex flex-col space-y-4">
                        <div>
                            <label for="mapStartDate" class="block text-gray-700 text-sm font-bold mb-2">Fecha Inicio:</label>
                            <input type="date" id="mapStartDate" class="form-input">
                        </div>
                        <div>
                            <label for="mapEndDate" class="block text-gray-700 text-sm font-bold mb-2">Fecha Fin:</label>
                            <input type="date" id="mapEndDate" class="form-input">
                        </div>
                        <button id="applyMapFilters" class="btn py-2 px-4 rounded-lg">
                            Aplicar Filtros de Recorrido
                        </button>
                        <button id="resetMapFilters" class="btn bg-gray-400 hover:bg-gray-500 py-2 px-4 rounded-lg">
                            Reiniciar Filtros de Recorrido
                        </button>
                    </div>
                </div>
                <!-- Parámetros de Detección de Anomalías -->
                <div>
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">Parámetros de Detección de Anomalías</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="minPulse" class="block text-gray-700 text-sm font-bold mb-1">Pulso Mín. (ppm):</label>
                            <input type="number" id="minPulse" value="40" class="form-input">
                        </div>
                        <div>
                            <label for="maxPulse" class="block text-gray-700 text-sm font-bold mb-1">Pulso Máx. (ppm):</label>
                            <input type="number" id="maxPulse" value="120" class="form-input">
                        </div>
                        <div>
                            <label for="minSpO2" class="block text-gray-700 text-sm font-bold mb-1">Oxígeno Mín. (%):</label>
                            <input type="number" id="minSpO2" value="90" class="form-input">
                        </div>
                        <div>
                            <label for="maxSpO2" class="block text-gray-700 text-sm font-bold mb-1">Oxígeno Máx. (%):</label>
                            <input type="number" id="maxSpO2" value="100" class="form-input">
                        </div>
                        <div>
                            <label for="minStepsPerDay" class="block text-gray-700 text-sm font-bold mb-1">Pasos Mín. Diarios:</label>
                            <input type="number" id="minStepsPerDay" value="5000" class="form-input">
                        </div>
                        <div>
                            <label for="minSleepHours" class="block text-gray-700 text-sm font-bold mb-1">Horas Sueño Mín.:</label>
                            <input type="number" id="minSleepHours" value="6" class="form-input">
                        </div>
                        <div>
                            <label for="maxSleepHours" class="block text-gray-700 text-sm font-bold mb-1">Horas Sueño Máx.:</label>
                            <input type="number" id="maxSleepHours" value="9" class="form-input">
                        </div>
                        <div>
                            <label for="minTemperature" class="block text-gray-700 text-sm font-bold mb-1">Temp. Mín. (°C):</label>
                            <input type="number" id="minTemperature" value="35.0" step="0.1" class="form-input">
                        </div>
                        <div>
                            <label for="maxTemperature" class="block text-gray-700 text-sm font-bold mb-1">Temp. Máx. (°C):</label>
                            <input type="number" id="maxTemperature" value="37.5" step="0.1" class="form-input">
                        </div>
                    </div>
                    <button id="saveAnomalySettings" class="btn bg-green-600 hover:bg-green-700 mt-4 w-full">
                        Guardar Configuración Anomalías
                    </button>
                </div>
            </div>

            <div id="mapid"></div>

            <h3 class="text-xl font-semibold text-gray-700 mb-4">Datos Recopilados y Anomalías</h3>
            <div class="data-table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Fecha y Hora</th>
                            <th>Latitud</th>
                            <th>Longitud</th>
                            <th>Pulso (ppm)</th>
                            <th>SpO2 (%)</th>
                            <th>Pasos (Diario)</th>
                            <th>Movimiento (X/Y/Z)</th>
                            <th>Temp. (°C)</th>
                            <th>Anomalías</th>
                        </tr>
                    </thead>
                    <tbody id="dataMapTableBody">
                        <!-- Los datos se insertarán aquí por JavaScript -->
                    </tbody>
                </table>
            </div>
            <p id="noMapDataMessage" class="text-center py-8 text-gray-500 hidden">
                No hay datos de recorrido disponibles para el rango de fechas seleccionado.
            </p>
        </div>

        <div id="mainTripsSection" class="main-tab-content hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Organizar Viajes</h2>
            <p class="text-center text-gray-600">Planifica tus viajes, rutas y presupuestos. ¡Próximamente!</p>
            <p class="text-center text-gray-500 mt-4">Puedes añadir formularios y listas para gestionar tus planes de viaje.</p>
        </div>

        <div id="mainMenusSection" class="main-tab-content hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Menús de Comida</h2>
            <p class="text-center text-gray-600">Organiza tus comidas semanales y listas de la compra. ¡Paciencia, pronto estará listo!</p>
            <p class="text-center text-gray-500 mt-4">Aquí podrías tener un calendario, recetas y opciones de filtrado.</p>
        </div>

        <div id="mainProjectsSection" class="main-tab-content hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Gestión de Proyectos</h2>
            <p class="text-center text-gray-600">Gestiona tus tareas, plazos y objetivos de tus proyectos personales o profesionales. ¡Trabajando en ello!</p>
            <p class="text-center text-gray-500 mt-4">Tableros Kanban o listas de tareas serían útiles aquí.</p>
        </div>

        <div id="messageBox" class="message-box w-full mt-8"></div>
    </div>

    <!-- Leaflet JS para el mapa -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjGwZT6P2JyTFDsRHACkMM0aCN1R6M="
     crossorigin=""></script>
    <script>
        // ¡IMPORTANTE! Reemplaza este URL con el URL de tu Google Apps Script desplegado (Servidor de Datos para la Web).
        const GOOGLE_APPS_SCRIPT_WEB_DATA_URL = 'URL_DE_TU_APPS_SCRIPT_SERVIDOR_DATOS';
        // ¡IMPORTANTE! Reemplaza este URL con el URL de tu Google Apps Script desplegado (Receptor de Datos del Diario).
        const GOOGLE_APPS_SCRIPT_DIARY_URL = 'https://script.google.com/macros/s/AKfycbx9q2YQCd2gYPfwoRayeO53O7DGrsUjSoiA3STD5xUVhAbh1ioDR5W0bcoCA9KecLLc/exec'; 


        let allBiometricData = []; // Almacena todos los datos biométricos/GPS crudos
        let map; // Objeto de mapa Leaflet
        let markers = L.featureGroup(); // Grupo para marcadores del mapa
        let polyline; // Línea para trazar el recorrido

        // Elementos del DOM para la navegación principal
        const mainTabButtons = document.querySelectorAll('.main-tab-button');
        const mainHomeSection = document.getElementById('mainHomeSection');
        const mainDiarySection = document.getElementById('mainDiarySection');
        const mainMapsSection = document.getElementById('mainMapsSection');
        const mainTripsSection = document.getElementById('mainTripsSection');
        const mainMenusSection = document.getElementById('mainMenusSection');
        const mainProjectsSection = document.getElementById('mainProjectsSection');

        // Elementos del DOM para la sub-navegación del Diario
        const diarySubTabButtons = document.querySelectorAll('.diary-sub-tab-button');
        const diaryWriteEntrySection = document.getElementById('diaryWriteEntrySection');
        const diaryViewSearchSection = document.getElementById('diaryViewSearchSection');

        // Elementos del DOM para la lógica del Diario
        const latestEntryContent = document.getElementById('latestEntryContent');
        const searchEntriesBtn = document.getElementById('searchEntriesBtn');
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        const searchResultsDiv = document.getElementById('searchResults');
        const diaryForm = document.getElementById('diaryForm');
        const text = document.getElementById('text');
        const photoUpload = document.getElementById('photoUpload');
        const externalImageUrlInput = document.getElementById('externalImageUrl');
        const messageBox = document.getElementById('messageBox');
        const buttonText = document.getElementById('buttonText');
        const loadingSpinner = document.getElementById('loadingSpinner');

        // Elementos del modal
        const imageModal = document.getElementById('imageModal');
        const modalImage = document.getElementById('modalImage');
        const closeModal = document.querySelector('.close-modal');

        // Elementos del DOM para la sección de Mapas y Datos
        const mapStartDateInput = document.getElementById('mapStartDate');
        const mapEndDateInput = document.getElementById('mapEndDate');
        const applyMapFiltersBtn = document.getElementById('applyMapFilters');
        const resetMapFiltersBtn = document.getElementById('resetMapFilters');
        const dataMapTableBody = document.getElementById('dataMapTableBody');
        const noMapDataMessage = document.getElementById('noMapDataMessage');

        // Elementos de la configuración de anomalías
        const minPulseInput = document.getElementById('minPulse');
        const maxPulseInput = document.getElementById('maxPulse');
        const minSpO2Input = document.getElementById('minSpO2');
        const maxSpO2Input = document.getElementById('maxSpO2');
        const minStepsPerDayInput = document.getElementById('minStepsPerDay');
        const minSleepHoursInput = document.getElementById('minSleepHours');
        const maxSleepHoursInput = document.getElementById('maxSleepHours');
        const minTemperatureInput = document.getElementById('minTemperature');
        const maxTemperatureInput = document.getElementById('maxTemperature');
        const saveAnomalySettingsBtn = document.getElementById('saveAnomalySettings');

        // Configuración de anomalías (valores por defecto)
        let anomalySettings = {
            minPulse: 40,
            maxPulse: 120,
            minSpO2: 90,
            maxSpO2: 100,
            minStepsPerDay: 5000,
            minSleepHours: 6,
            maxSleepHours: 9,
            minTemperature: 35.0,
            maxTemperature: 37.5
        };

        // --- Funciones de Utilidad (existentes y nuevas) ---

        // Función para mostrar mensajes al usuario (éxito/error)
        function showMessage(message, type) {
            messageBox.textContent = message;
            messageBox.className = `message-box w-full ${type}`;
            messageBox.style.display = 'block';
        }

        // Función para ocultar mensajes
        function hideMessage() {
            messageBox.style.display = 'none';
            messageBox.textContent = '';
            messageBox.className = 'message-box w-full';
        }

        // Función auxiliar para leer un archivo como Base64
        function readFileAsBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        // Función para resetear el estado del formulario
        function resetFormState() {
            buttonText.textContent = 'Guardar Entrada';
            loadingSpinner.style.display = 'none';
            diaryForm.querySelector('button[type="submit"]').disabled = false;
        }

        // Función para formatear la fecha
        function formatDate(timestamp) {
            const date = new Date(timestamp);
            const options = { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit' };
            return date.toLocaleDateString('es-ES', options);
        }

        // Función para intentar múltiples URLs de imagen (EXISTENTE, no la cambio)
        function tryMultipleImageUrls(originalUrl, imgElement, callback) {
            const urls = [];
            
            // Añadir la URL original
            urls.push(originalUrl);
            
            // Si es ImgBB, intentar diferentes formatos
            if (originalUrl.includes('ibb.co/') && !originalUrl.includes('i.ibb.co')) {
                const match = originalUrl.match(/ibb\.co\/([a-zA-Z0-9]+)/);
                if (match && match[1]) {
                    urls.push(`https://i.ibb.co/${match[1]}/image.jpg`);
                    urls.push(`https://i.ibb.co/${match[1]}/image.png`);
                    urls.push(`https://i.ibb.co/${match[1]}/image.webp`);
                }
            }
            
            let currentIndex = 0;
            
            function tryNextUrl() {
                if (currentIndex >= urls.length) {
                    // Si ninguna URL funciona, mostrar imagen placeholder
                    imgElement.src = 'https://placehold.co/400x300/e0e0e0/ffffff?text=Imagen+no+disponible';
                    imgElement.alt = 'Imagen no disponible';
                    if (callback) callback(false);
                    return;
                }
                
                const testImg = new Image();
                testImg.onload = function() {
                    imgElement.src = urls[currentIndex];
                    if (callback) callback(true);
                };
                testImg.onerror = function() {
                    currentIndex++;
                    tryNextUrl();
                };
                testImg.src = urls[currentIndex];
            }
            
            tryNextUrl();
        }

        // Función para renderizar una entrada de diario (EXISTENTE, no la cambio)
        function renderEntry(entry, containerElement) {
            const entryCard = document.createElement('div');
            entryCard.className = 'entry-card';

            const datePara = document.createElement('p');
            datePara.className = 'text-sm text-gray-500 mb-2';
            datePara.textContent = `Fecha: ${formatDate(entry.timestamp)}`;
            entryCard.appendChild(datePara);

            const textPara = document.createElement('p');
            textPara.className = 'text-base text-gray-800 whitespace-pre-wrap';
            textPara.textContent = entry.text;
            entryCard.appendChild(textPara);

            // Verificar si hay una URL de foto válida
            if (entry.photoUrl && entry.photoUrl !== 'No hay foto' && !entry.photoUrl.startsWith('Error')) {
                const imageContainer = document.createElement('div');
                imageContainer.className = 'mt-4';
                
                const loadingIndicator = document.createElement('div');
                loadingIndicator.innerHTML = '<span class="image-loading"></span>Cargando imagen...';
                loadingIndicator.className = 'text-sm text-gray-500 flex items-center';
                imageContainer.appendChild(loadingIndicator);
                
                const img = document.createElement('img');
                img.className = 'mt-4 rounded-lg shadow-md hidden';
                img.alt = 'Foto de la entrada del diario';
                
                // Añadir evento de clic para mostrar en modal
                img.addEventListener('click', function() {
                    modalImage.src = this.src;
                    imageModal.style.display = 'block';
                });
                
                imageContainer.appendChild(img);
                entryCard.appendChild(imageContainer);
                
                // Intentar cargar la imagen con múltiples URLs si es necesario
                tryMultipleImageUrls(entry.photoUrl, img, function(success) {
                    loadingIndicator.style.display = 'none';
                    if (success) {
                        img.classList.remove('hidden');
                    } else {
                        const errorPara = document.createElement('p');
                        errorPara.className = 'text-sm text-red-500 mt-2';
                        errorPara.textContent = 'No se pudo cargar la imagen';
                        imageContainer.appendChild(errorPara);
                    }
                });
                
            } else if (entry.photoUrl && entry.photoUrl.startsWith('Error')) {
                const errorPara = document.createElement('p');
                errorPara.className = 'text-sm text-red-500 mt-2';
                errorPara.textContent = `Error con la foto: ${entry.photoUrl}`;
                entryCard.appendChild(errorPara);
            }

            containerElement.appendChild(entryCard);
        }

        // Event listeners para el modal (EXISTENTE, no las cambio)
        closeModal.addEventListener('click', function() {
            imageModal.style.display = 'none';
        });

        imageModal.addEventListener('click', function(e) {
            if (e.target === imageModal) {
                imageModal.style.display = 'none';
            }
        });

        // --- Funciones de Navegación Principal ---

        function showMainTab(tabName) {
            console.log(`Cambiando a la pestaña: ${tabName}`); // Mensaje de depuración

            // Ocultar todas las secciones
            mainHomeSection.classList.add('hidden');
            mainDiarySection.classList.add('hidden');
            mainMapsSection.classList.add('hidden');
            mainTripsSection.classList.add('hidden');
            mainMenusSection.classList.add('hidden');
            mainProjectsSection.classList.add('hidden');

            // Desactivar todos los botones
            mainTabButtons.forEach(button => button.classList.remove('active'));

            // Mostrar la sección correspondiente
            if (tabName === 'home') {
                mainHomeSection.classList.remove('hidden');
                document.querySelector('[data-main-tab="home"]').classList.add('active');
                loadLatestEntry();
            } else if (tabName === 'diary') {
                mainDiarySection.classList.remove('hidden');
                document.querySelector('[data-main-tab="diary"]').classList.add('active');
                showDiarySubTab('write');
            } else if (tabName === 'maps') {
                mainMapsSection.classList.remove('hidden');
                document.querySelector('[data-main-tab="maps"]').classList.add('active');
                // Al ir a la pestaña de mapas, inicializar o actualizar
                initializeMap(); // Asegura que el mapa se inicializa si no lo estaba
                loadAnomalySettings(); // Cargar ajustes de anomalías
                fetchBiometricData(); // Cargar los datos del ESP32/Android
            } else if (tabName === 'trips') {
                mainTripsSection.classList.remove('hidden');
                document.querySelector('[data-main-tab="trips"]').classList.add('active');
            } else if (tabName === 'menus') {
                mainMenusSection.classList.remove('hidden');
                document.querySelector('[data-main-tab="menus"]').classList.add('active');
            } else if (tabName === 'projects') {
                mainProjectsSection.classList.remove('hidden');
                document.querySelector('[data-main-tab="projects"]').classList.add('active');
            }
            hideMessage(); // Ocultar mensajes generales al cambiar de pestaña
        }

        // Event listeners para los botones de las pestañas principales (EXISTENTE, no la cambio)
        mainTabButtons.forEach(button => {
            button.addEventListener('click', () => {
                showMainTab(button.dataset.mainTab);
            });
        });

        
        // --- Funciones de Sub-navegación del Diario (EXISTENTE, no la cambio) ---

        function showDiarySubTab(subTabName) {
            // Ocultar todas las sub-secciones
            diaryWriteEntrySection.classList.add('hidden');
            diaryViewSearchSection.classList.add('hidden');

            // Desactivar todos los botones de sub-pestaña
            diarySubTabButtons.forEach(button => button.classList.remove('active'));

            // Mostrar la sub-sección correspondiente
            if (subTabName === 'write') {
                diaryWriteEntrySection.classList.remove('hidden');
                document.querySelector('[data-diary-sub-tab="write"]').classList.add('active');
            } else if (subTabName === 'view') {
                diaryViewSearchSection.classList.remove('hidden');
                document.querySelector('[data-diary-sub-tab="view"]').classList.add('active');
                searchResultsDiv.innerHTML = '<p class="text-center text-gray-500">Usa el filtro de fechas para buscar entradas.</p>';
            }
            hideMessage();
        }

        // Event listeners para los botones de las sub-pestañas del diario (EXISTENTE, no la cambio)
        diarySubTabButtons.forEach(button => {
            button.addEventListener('click', () => {
                showDiarySubTab(button.dataset.diarySubTab);
            });
        });

        // --- Funciones del Diario (EXISTENTE, no las cambio) ---

        async function loadLatestEntry() {
            latestEntryContent.innerHTML = '<p class="text-center text-gray-500">Cargando última entrada del diario...</p>';
            try {
                const response = await fetch(`${GOOGLE_APPS_SCRIPT_DIARY_URL}?action=getLatest`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const result = await response.json();

                if (result.status === 'success' && result.entry) {
                    latestEntryContent.innerHTML = '';
                    renderEntry(result.entry, latestEntryContent);
                } else {
                    latestEntryContent.innerHTML = `<p class="text-center text-gray-500">${result.message || 'No hay entradas para mostrar.'}</p>`;
                }
            } catch (error) {
                console.error('Error al cargar la última entrada:', error);
                latestEntryContent.innerHTML = '<p class="text-center text-red-500">Error al cargar la última entrada.</p>';
            }
        }

        // Envío del formulario del diario (EXISTENTE, no la cambio)
        diaryForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            hideMessage();
            buttonText.textContent = 'Guardando...';
            loadingSpinner.style.display = 'block';
            diaryForm.querySelector('button[type="submit"]').disabled = true;

            const entryText = text.value;
            const externalImageUrl = externalImageUrlInput.value.trim();
            let imageData = null;
            let imageName = '';

            // Validación
            if (!entryText.trim()) {
                showMessage('Por favor, escribe algo en tu entrada del diario.', 'error');
                resetFormState();
                return;
            }

            // Validar que no se usen ambos métodos de imagen
            if (photoUpload.files.length > 0 && externalImageUrl !== '') {
                showMessage('Por favor, elige SOLO UNA opción para la imagen: o subir un archivo O pegar una URL.', 'error');
                resetFormState();
                return;
            }

            // Procesar imagen si existe
            if (photoUpload.files.length > 0) {
                const file = photoUpload.files[0];
                const MAX_FILE_SIZE = 5 * 1024 * 1024; 
                if (file.size > MAX_FILE_SIZE) {
                    showMessage('La imagen es demasiado grande (máximo 5MB).', 'error');
                    resetFormState();
                    return;
                }
                imageName = file.name;
                try {
                    imageData = await readFileAsBase64(file);
                } catch (error) {
                    showMessage('Error al leer la imagen. Inténtalo de nuevo.', 'error');
                    resetFormState();
                    return;
                }
            }

            // Preparar datos para enviar - CORREGIDO para coincidir con el script
            const formData = new FormData();
            formData.append('diaryEntry', entryText); // Cambiado de 'text' a 'diaryEntry'
            
            if (externalImageUrl !== '') {
                formData.append('externalImageUrl', externalImageUrl);
            } else if (imageData) {
                formData.append('imageData', imageData);
                formData.append('imageName', imageName);
            }

            try {
                const response = await fetch(GOOGLE_APPS_SCRIPT_DIARY_URL, {
                    method: 'POST',
                    body: formData,
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();

                if (result.status === 'success') {
                    showMessage('¡Entrada guardada con éxito!', 'success');
                    text.value = '';
                    photoUpload.value = '';
                    externalImageUrlInput.value = '';
                } else {
                    showMessage(`Error al guardar: ${result.message || 'Error desconocido'}`, 'error');
                }
            } catch (error) {
                console.error('Error al enviar la entrada:', error);
                showMessage('Ha ocurrido un error al conectar con el servidor. Inténtalo de nuevo más tarde.', 'error');
            } finally {
                resetFormState();
            }
        });

        // Búsqueda de entradas por fecha (EXISTENTE, no la cambio)
        searchEntriesBtn.addEventListener('click', async () => {
            const startDate = startDateInput.value;
            const endDate = endDateInput.value;

            if (!startDate || !endDate) {
                showMessage('Por favor, selecciona tanto la fecha de inicio como la de fin para buscar.', 'error');
                return;
            }

            if (new Date(startDate) > new Date(endDate)) {
                showMessage('La fecha de inicio no puede ser posterior a la fecha de fin.', 'error');
                return;
            }

            searchResultsDiv.innerHTML = '<p class="text-center text-gray-500">Buscando entradas...</p>';
            hideMessage();

            try {
                const response = await fetch(`${GOOGLE_APPS_SCRIPT_DIARY_URL}?action=getEntriesByDate&startDate=${startDate}&endDate=${endDate}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const result = await response.json();

                if (result.status === 'success' && result.entries && result.entries.length > 0) {
                    searchResultsDiv.innerHTML = '';
                    result.entries.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    result.entries.forEach(entry => renderEntry(entry, searchResultsDiv));
                } else {
                    searchResultsDiv.innerHTML = `<p class="text-center text-gray-500">${result.message || 'No se encontraron entradas para el rango de fechas seleccionado.'}</p>`;
                }
            } catch (error) {
                console.error('Error al buscar entradas:', error);
                searchResultsDiv.innerHTML = '<p class="text-center text-red-500">Error al buscar entradas. Inténtalo de nuevo.</p>';
            }
        });

        // --- Nuevas Funciones para la Sección de Mapas y Datos Biométricos ---

        /**
         * Inicializa el mapa Leaflet.
         * Se asegura de que se inicialice solo una vez o se reinicie correctamente.
         */
        function initializeMap() {
            if (map) {
                map.remove(); // Elimina el mapa existente si ya fue inicializado
            }
            map = L.map('mapid').setView([0, 0], 2); // Vista inicial, se ajustará con los datos

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            markers.addTo(map); // Añade el grupo de marcadores al mapa
            polyline = L.polyline([], {color: 'blue'}).addTo(map); // Línea para el recorrido
        }

        /**
         * Carga la configuración de anomalías desde localStorage o usa los valores por defecto.
         */
        function loadAnomalySettings() {
            const savedSettings = localStorage.getItem('anomalySettings');
            if (savedSettings) {
                anomalySettings = JSON.parse(savedSettings);
            }
            // Asigna los valores a los inputs
            minPulseInput.value = anomalySettings.minPulse;
            maxPulseInput.value = anomalySettings.maxPulse;
            minSpO2Input.value = anomalySettings.minSpO2;
            maxSpO2Input.value = anomalySettings.maxSpO2;
            minStepsPerDayInput.value = anomalySettings.minStepsPerDay;
            minSleepHoursInput.value = anomalySettings.minSleepHours;
            maxSleepHoursInput.value = anomalySettings.maxSleepHours;
            minTemperatureInput.value = anomalySettings.minTemperature;
            maxTemperatureInput.value = anomalySettings.maxTemperature;
        }

        /**
         * Guarda la configuración actual de anomalías en localStorage.
         */
        function saveAnomalySettings() {
            anomalySettings.minPulse = parseFloat(minPulseInput.value);
            anomalySettings.maxPulse = parseFloat(maxPulseInput.value);
            anomalySettings.minSpO2 = parseFloat(minSpO2Input.value);
            anomalySettings.maxSpO2 = parseFloat(maxSpO2Input.value);
            anomalySettings.minStepsPerDay = parseFloat(minStepsPerDayInput.value);
            anomalySettings.minSleepHours = parseFloat(minSleepHoursInput.value);
            anomalySettings.maxSleepHours = parseFloat(maxSleepHoursInput.value);
            anomalySettings.minTemperature = parseFloat(minTemperatureInput.value);
            anomalySettings.maxTemperature = parseFloat(maxTemperatureInput.value);

            localStorage.setItem('anomalySettings', JSON.stringify(anomalySettings));
            showMessage('Configuración de anomalías guardada correctamente.', 'success');
            filterAndDisplayBiometricData(); // Refrescar datos con nueva configuración
        }

        /**
         * Obtiene los datos biométricos/GPS de la hoja de cálculo a través del Apps Script.
         */
        async function fetchBiometricData() {
            noMapDataMessage.classList.add('hidden');
            dataMapTableBody.innerHTML = '';
            markers.clearLayers();
            polyline.setLatLngs([]); // Limpiar la polilínea

            showMessage('Cargando datos de recorrido...', 'info');
            try {
                // Usamos el GOOGLE_APPS_SCRIPT_WEB_DATA_URL para obtener los datos
                const response = await fetch(GOOGLE_APPS_SCRIPT_WEB_DATA_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error: ${response.status}`);
                }
                allBiometricData = await response.json();

                // Convertir Timestamps a objetos Date
                allBiometricData.forEach(d => {
                    // El timestamp puede ser un número (milisegundos) o una cadena de texto ISO.
                    // Asegúrate de que Date pueda parsearlo. Si viene de ESP32, es un número.
                    // Si viene del diario, podría ser una cadena.
                    d.Timestamp = new Date(d.Timestamp);
                });

                showMessage('Datos de recorrido cargados exitosamente.', 'success');
                filterAndDisplayBiometricData(); // Mostrar datos iniciales
            } catch (error) {
                console.error('Error al obtener datos de recorrido:', error);
                showMessage(`Error al cargar datos de recorrido: ${error.message}. Asegúrate de que la URL de Google Apps Script sea correcta y esté desplegada.`, 'error');
                noMapDataMessage.classList.remove('hidden');
            }
        }

        /**
         * Filtra y muestra los datos biométricos en la tabla y el mapa.
         */
        function filterAndDisplayBiometricData() {
            const startDate = mapStartDateInput.value ? new Date(mapStartDateInput.value + 'T00:00:00') : null;
            const endDate = mapEndDateInput.value ? new Date(mapEndDateInput.value + 'T23:59:59') : null;

            let filteredData = allBiometricData.filter(d => {
                const timestamp = d.Timestamp;
                return (!startDate || timestamp >= startDate) && (!endDate || timestamp <= endDate);
            });

            // Ordenar por fecha, los más recientes primero
            filteredData.sort((a, b) => b.Timestamp.getTime() - a.Timestamp.getTime());

            processAndRenderBiometricData(filteredData);
        }

        /**
         * Procesa los datos (calcula pasos diarios, detecta anomalías) y los renderiza.
         * @param {Array<Object>} data Los datos filtrados a procesar y mostrar.
         */
        function processAndRenderBiometricData(data) {
            dataMapTableBody.innerHTML = ''; // Limpia la tabla
            markers.clearLayers(); // Limpiar marcadores existentes del mapa
            polyline.setLatLngs([]); // Limpiar la polilínea

            if (data.length === 0) {
                noMapDataMessage.classList.remove('hidden');
                map.setView([0, 0], 2); // Restablece la vista del mapa
                return;
            } else {
                noMapDataMessage.classList.add('hidden');
            }

            // Para calcular pasos diarios y horas de sueño
            const dailyAggregates = {}; // { 'YYYY-MM-DD': { totalSteps: X, sleepEntries: [], entryCount: 0 } }

            let firstValidLatLng = null; // Para centrar el mapa en la primera ubicación válida
            const latLngsForPolyline = []; // Para la línea del recorrido

            // Procesar y agregar datos a dailyAggregates primero
            data.forEach(d => {
                const dateKey = d.Timestamp.toISOString().split('T')[0]; // YYYY-MM-DD
                if (!dailyAggregates[dateKey]) {
                    dailyAggregates[dateKey] = { totalSteps: 0, sleepEntries: [], entryCount: 0 };
                }
                if (d.Steps !== undefined && d.Steps !== null && !isNaN(d.Steps)) {
                    dailyAggregates[dateKey].totalSteps += parseInt(d.Steps);
                }
                // Si tienes un campo de "SleepHours" en tus datos, agrégalo aquí.
                // Asumiendo que 'SleepHours' es un valor por entrada que representa horas de sueño para esa entrada.
                // La lógica de agregación de sueño puede ser más compleja y depender de cómo se recolectan los datos.
                if (d.SleepHours !== undefined && d.SleepHours !== null && !isNaN(d.SleepHours)) {
                     dailyAggregates[dateKey].sleepEntries.push(d.SleepHours);
                }
                dailyAggregates[dateKey].entryCount++;
            });


            data.forEach(d => {
                const dateKey = d.Timestamp.toISOString().split('T')[0]; // YYYY-MM-DD
                const dailyAggregate = dailyAggregates[dateKey];

                // Detección de anomalías para esta entrada
                const anomalies = [];
                let isAnomaly = false;

                if (d.Pulse !== undefined && d.Pulse !== null && !isNaN(d.Pulse) && d.Pulse !== -1) {
                    if (d.Pulse < anomalySettings.minPulse) anomalies.push('Pulso Bajo');
                    if (d.Pulse > anomalySettings.maxPulse) anomalies.push('Pulso Alto');
                }
                if (d.SpO2 !== undefined && d.SpO2 !== null && !isNaN(d.SpO2) && d.SpO2 !== -1) {
                    if (d.SpO2 < anomalySettings.minSpO2) anomalies.push('Oxígeno Bajo');
                    if (d.SpO2 > anomalySettings.maxSpO2) anomalies.push('Oxígeno Alto');
                }
                 if (d.Temperature !== undefined && d.Temperature !== null && !isNaN(d.Temperature) && d.Temperature !== -1.0) {
                    if (d.Temperature < anomalySettings.minTemperature) anomalies.push('Temp. Baja');
                    if (d.Temperature > anomalySettings.maxTemperature) anomalies.push('Temp. Alta');
                }
                
                // Anomalías basadas en agregados diarios (pasos, sueño)
                if (dailyAggregate) {
                    if (dailyAggregate.totalSteps < anomalySettings.minStepsPerDay && dailyAggregate.totalSteps > 0) { // Solo si hay pasos registrados
                        anomalies.push('Pasos Bajos');
                    }
                    if (dailyAggregate.sleepEntries.length > 0) {
                        const avgSleepHours = dailyAggregate.sleepEntries.reduce((a, b) => a + b, 0) / dailyAggregate.sleepEntries.length;
                        if (avgSleepHours < anomalySettings.minSleepHours) {
                            anomalies.push('Sueño Insuficiente');
                        }
                        if (avgSleepHours > anomalySettings.maxSleepHours) {
                            anomalies.push('Exceso de Sueño');
                        }
                    }
                }
                
                if (anomalies.length > 0) {
                    isAnomaly = true;
                }

                // Crear fila de tabla
                const row = dataMapTableBody.insertRow();
                if (isAnomaly) {
                    row.classList.add('anomaly-row');
                }

                row.insertCell().textContent = formatDate(d.Timestamp);
                row.insertCell().textContent = d.Latitude !== undefined && d.Latitude !== 0.0 ? d.Latitude.toFixed(6) : 'N/D';
                row.insertCell().textContent = d.Longitude !== undefined && d.Longitude !== 0.0 ? d.Longitude.toFixed(6) : 'N/D';
                row.insertCell().textContent = d.Pulse !== undefined && d.Pulse !== -1 ? d.Pulse : 'N/D';
                row.insertCell().textContent = d.SpO2 !== undefined && d.SpO2 !== -1 ? d.SpO2 : 'N/D';
                row.insertCell().textContent = dailyAggregate ? dailyAggregate.totalSteps : 'N/D'; // Pasos diarios
                row.insertCell().textContent = d.MovementX !== undefined ? `X:${d.MovementX.toFixed(2)}, Y:${d.MovementY.toFixed(2)}, Z:${d.MovementZ.toFixed(2)}` : 'N/D';
                row.insertCell().textContent = d.Temperature !== undefined && d.Temperature !== -1.0 ? d.Temperature.toFixed(1) : 'N/D';
                
                // Celda de Anomalías
                const anomalyTextCell = row.insertCell();
                if (anomalies.length > 0) {
                    anomalyTextCell.textContent = anomalies.join(', ');
                    anomalyTextCell.classList.add('anomaly-text');
                } else {
                    anomalyTextCell.textContent = 'Ninguna';
                }

                // Añadir marcador al mapa si hay coordenadas válidas
                if (d.Latitude && d.Longitude && d.Latitude !== 0.0 && d.Longitude !== 0.0 && !isNaN(d.Latitude) && !isNaN(d.Longitude)) {
                    const latLng = [d.Latitude, d.Longitude];
                    if (!firstValidLatLng) {
                        firstValidLatLng = latLng;
                    }
                    latLngsForPolyline.push(latLng);

                    const markerColor = isAnomaly ? '#ef4444' : '#4f46e5'; // Rojo para anomalía, morado para normal
                    const customIcon = L.divIcon({
                        className: 'custom-div-icon',
                        html: `<div style="background-color:${markerColor}; width:10px; height:10px; border-radius:50%; border: 1px solid white;"></div>`,
                        iconSize: [12, 12],
                        iconAnchor: [6, 6]
                    });

                    const marker = L.marker(latLng, { icon: customIcon })
                        .bindPopup(`<b>${formatDate(d.Timestamp)}</b><br>Lat: ${d.Latitude.toFixed(6)}, Lon: ${d.Longitude.toFixed(6)}<br>Pulso: ${d.Pulse !== -1 ? d.Pulse : 'N/D'}<br>SpO2: ${d.SpO2 !== -1 ? d.SpO2 : 'N/D'}<br>Temp: ${d.Temperature !== -1.0 ? d.Temperature.toFixed(1) + '°C' : 'N/D'}<br>Anomalías: ${anomalies.length > 0 ? anomalies.join(', ') : 'Ninguna'}`);
                    markers.addLayer(marker);
                }
            });

            // Ajustar el mapa para que muestre todos los marcadores o el primer punto válido
            if (markers.getLayers().length > 0) {
                map.fitBounds(markers.getBounds(), {padding: L.point(50, 50)}); // Añadir padding para que no se pegue a los bordes
                polyline.setLatLngs(latLngsForPolyline); // Dibujar la línea de recorrido
            } else if (firstValidLatLng) {
                map.setView(firstValidLatLng, 13); // Centrar en el primer punto si no hay múltiples marcadores
            }
        }

        // Event Listeners para la sección de Mapas
        applyMapFiltersBtn.addEventListener('click', filterAndDisplayBiometricData);
        resetMapFiltersBtn.addEventListener('click', () => {
            mapStartDateInput.value = '';
            mapEndDateInput.value = '';
            filterAndDisplayBiometricData();
        });
        saveAnomalySettingsBtn.addEventListener('click', saveAnomalySettings);


        // --- Inicialización General ---
        document.addEventListener('DOMContentLoaded', () => {
            showMainTab('home'); // Muestra la pestaña de inicio por defecto
        });

        // Asegurarse de que el mapa se renderice correctamente si el contenedor cambia de tamaño
        window.addEventListener('resize', () => {
            if (map && mainMapsSection.classList.contains('active')) { // Solo invalidate si la pestaña de mapas está activa
                map.invalidateSize();
            }
        });
    </script>
</body>
</html>
