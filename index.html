
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mi Web Completa</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 0; background: #f5f5f5; }
    nav { background: #333; color: white; display: flex; gap: 10px; padding: 10px; }
    nav button { background: #444; border: none; color: white; padding: 10px 20px; cursor: pointer; }
    .section { display: none; padding: 20px; }
    .section.active { display: block; }
    .highlight { background: #dff0d8; padding: 10px; margin-top: 10px; border-left: 5px solid green; }
    #map { height: 400px; }
    .controls { margin: 10px 0; }
    .controls button { margin-right: 8px; }
    .song-list { margin-top: 15px; }
    .song-list li { cursor: pointer; }
  </style>
</head>
<body>
  <nav>
    <button onclick="showSection('home')">Inicio</button>
    <button onclick="showSection('radio')">Radio</button>
    <button onclick="showSection('diario')">Diario</button>
    <button onclick="showSection('mapa')">Mapa</button>
  </nav>

  <div id="home" class="section active">
    <h2>Bienvenido</h2>
    <div id="latestEntryHome">Cargando √∫ltima entrada...</div>
  </div>

  <div id="radio" class="section">
    <h2>üéß Radio</h2>
    <div id="nowPlaying">
      <strong>Sonando:</strong> <span id="currentSong">---</span><br>
      <strong>A continuaci√≥n:</strong> <span id="nextSong">---</span>
    </div>
    <div class="controls">
      <button onclick="startRadio()" style="background:#ff4081;color:white;padding:10px 20px;border:none;border-radius:6px;cursor:pointer;font-size:16px;margin-top:10px;">‚ñ∂Ô∏è Empezar Radio</button>
      <button onclick="prevTrack()">‚èÆÔ∏è</button>
      <button onclick="nextTrack()">‚è≠Ô∏è</button>
      <button onclick="toggleRepeat()">üîÅ</button>
      <button onclick="toggleRandom()">üîÄ</button>
      <button onclick="toggleList()">üéµ list</button>
    </div>
    <audio id="audio" controls autoplay></audio>
    

    <canvas id="visualizer" width="600" height="100" style="width:100%; background:#111; display:block; margin-top:10px;"></canvas>
    <ul id="songList" class="song-list" style="display:none;"></ul>
  </div>

  <div id="diario" class="section">
    <h2>üìì Diario</h2>
    <form id="diaryForm">
      <input type="text" id="title" placeholder="T√≠tulo" required><br><br>
      <textarea id="entry" placeholder="Escribe aqu√≠..." rows="4" required></textarea><br><br>
      <input type="url" id="imageUrl" placeholder="URL de imagen (opcional)"><br><br>
      <button type="submit">Guardar</button>
    </form>
    <div id="confirmationMsg"></div>
    <hr>
    <h3>Buscar entradas</h3>
    <input type="text" id="searchTitle" placeholder="T√≠tulo">
    <input type="date" id="startDate">
    <input type="date" id="endDate">
    <button onclick="searchEntries()">Buscar</button>
    <div id="searchResults"></div>
  </div>

  <div id="mapa" class="section">
    <h2>üó∫Ô∏è Mapa</h2>
    <div id="map"></div>
  </div>

<script>
const API_DIARIO = "https://script.google.com/macros/s/AKfycbxoTQVF1RMm2XckrFFXJ1heZ8P2W7carCAZaEw-XxI76bWp_oyKZy9kA1LlBPsxMQQL/exec";
const API_MAPS = "https://script.google.com/macros/s/AKfycbwXNtcVnXevJgk-fpMvqqkc4BeSbZZ_EutueaCAkakIaBK5sx7AQL-fZpN5R08uWNy3/exec";

let mapInitialized = false;
function showSection(id) {
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  if (id === 'mapa' && !mapInitialized) {
    setTimeout(() => {
      map.invalidateSize();
    }, 100);
    mapInitialized = true;
  }
}

// DIARIO
document.getElementById('diaryForm').addEventListener('submit', e => {
  e.preventDefault();
  const data = {
    title: document.getElementById('title').value,
    diaryEntry: document.getElementById('entry').value,
    externalImageUrl: document.getElementById('imageUrl').value
  };
    const formData = new FormData();
    formData.append("title", data.title);
    formData.append("diaryEntry", data.diaryEntry);
    formData.append("externalImageUrl", data.externalImageUrl);
    
    fetch(API_DIARIO, {
      method: 'POST',
      body: formData
    })

    .then(res => res.json())
    .then(res => {
      document.getElementById('confirmationMsg').innerHTML =
        `<div class="highlight">${res.message || 'Guardado correctamente.'}</div>`;
    });
});

function searchEntries() {
  const title = document.getElementById('searchTitle').value.trim();
  const start = document.getElementById('startDate').value;
  const end = document.getElementById('endDate').value;
  let url = API_DIARIO;
  if (title) {
    url += `?action=searchByTitle&keyword=${encodeURIComponent(title)}`;
  } else if (start && end) {
    url += `?action=getEntriesByDate&startDate=${start}&endDate=${end}`;
  } else {
    return alert("Introduce t√≠tulo o fecha de b√∫squeda.");
  }

  fetch(url).then(res => res.json()).then(res => {
    const out = document.getElementById('searchResults');
    out.innerHTML = '';
    (res.entries || []).forEach(e => {
      out.innerHTML += `<p>
        <strong>${e.title}</strong><br>
        ${e.text}
        ${e.photoUrl ? `<br><img src="${e.photoUrl}" width="250" alt="Imagen de la entrada">` : ''}
      </p>`;
    });
  });
}

fetch(API_DIARIO + "?action=getLatest")
  .then(res => res.json())
  .then(res => {
    const e = res.entry;
    if (e) {
      document.getElementById('latestEntryHome').innerHTML =
        `<h3>${e.title}</h3><p>${e.text}</p><img src="${e.photoUrl}" width="250">`;
    }
  });

// RADIO
let playlist = [];
let currentIndex = 0;
let repeatOne = false;
let repeatAll = false;
let random = false;
const audio = document.getElementById('audio');

fetch("music_list.json")
  .then(res => res.json())
  .then(data => {
    playlist = data;
    loadTrack(currentIndex);
    updateSongList();
  })
  .catch(err => console.error("Error al cargar playlist:", err));

function updateSongList() {
  const ul = document.getElementById('songList');
  ul.innerHTML = '';
  playlist.forEach((s, i) => {
    const li = document.createElement('li');
    let prefix = '';
    if (i === currentIndex) {
      prefix = 'üé∂ ';
    } else if (i === (currentIndex + 1) % playlist.length) {
      prefix = '‚û°Ô∏è ';
    }
    li.textContent = `${prefix}${s.title}`;
    li.onclick = () => loadTrack(i);
    ul.appendChild(li);
  });
}


function loadTrack(i) {
  if (!playlist[i]) return;
  currentIndex = i;
  audio.src = playlist[i].url;
  audio.play();

  document.getElementById("currentSong").textContent = playlist[i].title || "Sonando";
  const nextIndex = (i + 1) % playlist.length;
  document.getElementById("nextSong").textContent = playlist[nextIndex]?.title || "A continuaci√≥n";
  updateSongList();
}




function nextTrack() {
  if (random) {
    currentIndex = Math.floor(Math.random() * playlist.length);
  } else {
    currentIndex = (currentIndex + 1) % playlist.length;
  }
  loadTrack(currentIndex);
}

function prevTrack() {
  currentIndex = (currentIndex - 1 + playlist.length) % playlist.length;
  loadTrack(currentIndex);
}

function togglePlay() {
  if (audio.paused) audio.play(); else audio.pause();
}

function toggleRepeat() {
  if (!repeatOne && !repeatAll) {
    repeatOne = true;
    repeatAll = false;
    audio.loop = true;
    alert('Repetir una canci√≥n');
  } else if (repeatOne) {
    repeatOne = false;
    repeatAll = true;
    audio.loop = false;
    alert('Repetir toda la lista');
  } else {
    repeatOne = false;
    repeatAll = false;
    audio.loop = false;
    alert('Repetici√≥n desactivada');
  }
}

audio.onended = function() {
  if (repeatAll) {
    nextTrack();
  }
};

function toggleRandom() {
  random = !random;
  alert('Aleatorio: ' + (random ? 'activado' : 'desactivado'));
}

function toggleList() {
  const list = document.getElementById('songList');
  list.style.display = list.style.display === 'none' ? 'block' : 'none';
}

  audio.onended = () => {
  const nextIndex = (currentIndex + 1) % playlist.length;
  loadTrack(nextIndex);
};

function startRadio() {
  loadTrack(currentIndex);
  // visualizador se activar√° autom√°ticamente en play
}




// MAPA
const map = L.map('map').setView([40.4, -3.7], 6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '¬© OpenStreetMap contributors'
}).addTo(map);

fetch(API_MAPS)
  .then(res => res.json())
  .then(data => {
    data.forEach(p => {
      if (p.Latitude && p.Longitude) {
        L.marker([+p.Latitude, +p.Longitude]).addTo(map)
          .bindPopup(`Pulso: ${p.Pulse}<br>SpO2: ${p.SpO2}`);
      }
    });
  });

const canvas = document.getElementById('visualizer');
const ctx = canvas.getContext('2d');

let visualStarted = false;
let audioCtx, analyser, source, bufferLength, dataArray;

function initVisualizer() {
  if (visualStarted) return;
  visualStarted = true;

  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  analyser = audioCtx.createAnalyser();
  source = audioCtx.createMediaElementSource(audio);
  source.connect(analyser);
  analyser.connect(audioCtx.destination);
  analyser.fftSize = 256;
  bufferLength = analyser.frequencyBinCount;
  dataArray = new Uint8Array(bufferLength);

  drawVisualizer();
}

function drawVisualizer() {
  requestAnimationFrame(drawVisualizer);
  analyser.getByteFrequencyData(dataArray);

  ctx.fillStyle = '#111';
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  const barWidth = (canvas.width / bufferLength) * 2.5;
  let x = 0;

  for (let i = 0; i < bufferLength; i++) {
    const barHeight = dataArray[i] * 0.7;
    const r = 150 + barHeight / 2;
    const g = 50 + barHeight / 3;
    const b = 200;

    ctx.fillStyle = `rgb(${r},${g},${b})`;
    ctx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
    x += barWidth + 1;
  }
}

// Activa visualizador al primer play del usuario
audio.addEventListener('play', () => {
  if (!visualStarted) {
    setTimeout(() => {
      initVisualizer();
    }, 300); // da tiempo a que el audio comience
  }
  if (audioCtx && audioCtx.state === 'suspended') {
    audioCtx.resume();
  }
});



  
</script>
</body>
</html>
