<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Javi</title>
    <link rel="icon" type="image/jpeg" href="mi%20bandera.jpg">

    <!--<script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <!--<script src="https://cdn.tailwindcss.com"></script>
    <!-- Insertar en el <head> de tu HTML -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

    <style>
        /* Fuente Inter para un aspecto moderno y limpio */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Un gris claro para el fondo */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            background-image: url('mi%20bandera.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }
        .container {
            max-width: 900px; /* Ancho un poco mayor para las nuevas secciones */
            width: 100%;
            background-color: #ffffff;
            padding: 32px;
            border-us: 12px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.08);
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(8px);
        }
        .form-label {
            font-weight: 600;
            margin-bottom: 8px;
            display: block;
            color: #374151;
        }
        .form-input, .form-textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #d1d5db;
            border-us: 8px;
            font-size: 1rem;
            color: #1f2937;
            background-color: #f9fafb;
            transition: border-color 0.2s;
        }
        .form-input:focus, .form-textarea:focus {
            outline: none;
            border-color: #3b82f6; /* Un azul bonito al enfocar */
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25);
        }
        .btn {
            background-color: #4f46e5; /* Morado intenso */
            color: white;
            padding: 14px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .btn:hover {
            background-color: #4338ca; /* Morado m√°s oscuro al pasar el rat√≥n */
            transform: translateY(-1px);
        }
        .btn:active {
            transform: translateY(0);
        }
        .message-box {
            padding: 12px 20px;
            border-radius: 8px;
            margin-top: 20px;
            font-weight: 500;
            display: none; /* Oculto por defecto */
        }
        .message-box.success {
            background-color: #d1fae5; /* Verde claro */
            color: #065f46; /* Verde oscuro */
            border: 1px solid #10b981;
        }
        .message-box.error {
            background-color: #fee2e2; /* Rojo claro */
            color: #991b1b; /* Rojo oscuro */
            border: 1px solid #ef4444;
        }
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #ffffff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: none; /* Oculto por defecto */
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Estilos para las pesta√±as de navegaci√≥n principal */
        .main-tab-button {
            padding: 12px 20px;
            border-radius: 8px 8px 0 0;
            font-weight: 600;
            cursor: pointer;
            background-color: #e5e7eb; /* Gris claro */
            color: #4b5563;
            transition: background-color 0.2s, color 0.2s;
            white-space: nowrap; /* Evita que el texto se rompa */
        }
        .main-tab-button.active {
            background-color: #ffffff;
            color: #4f46e5; /* Morado */
            box-shadow: 0 -2px 0 0 #4f46e5 inset; /* Subrayado morado */
        }
        .main-tab-content {
            padding-top: 24px;
            border-top: 1px solid #e5e7eb;
        }

        /* Estilos para las sub-pesta√±as del diario */
        .diary-sub-tab-button {
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            background-color: #f3f4f6;
            color: #6b7280;
            transition: background-color 0.2s, color 0.2s;
            margin-right: 8px; /* Espacio entre botones */
        }
        .diary-sub-tab-button.active {
            background-color: #e0e7ff; /* Azul claro */
            color: #4f46e5; /* Morado */
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .diary-sub-tab-content {
            padding-top: 16px;
        }

        .hidden {
            display: none !important;
        }
        .entry-card {
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .entry-card img {
            max-width: 100%;
            height: auto;
            border-radius: 6px;
            margin-top: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.2s;
        }
        .entry-card img:hover {
            transform: scale(1.02);
        }
        
        /* Estilos para el modal de imagen */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
        }
        .modal-content {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            padding: 20px;
        }
        .modal-image {
            max-width: 90%;
            max-height: 90%;
            border-radius: 8px;
        }
        .close-modal {
            position: absolute;
            top: 20px;
            right: 30px;
            color: white;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-modal:hover {
            color: #ccc;
        }
        
        /* Indicador de carga para im√°genes */
        .image-loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #4f46e5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }
        .radio-button {
  background: linear-gradient(to right, #6366f1, #8b5cf6);
  color: white;
  padding: 10px 20px;
  border-radius: 9999px;
  font-weight: bold;
  transition: all 0.2s;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
}
.radio-button:hover {
  transform: scale(1.05);
  background: linear-gradient(to right, #4f46e5, #7c3aed);
}

.song-info-box {
  background-color: #f3f4f6;
  border: 2px solid #6366f1;
  padding: 12px 16px;
  border-radius: 12px;
  margin-bottom: 1rem;
  box-shadow: 0 2px 8px rgba(99, 102, 241, 0.15);
}
.song-info-title {
  font-weight: 700;
  color: #374151;
  font-size: 1rem;
}
.song-info-content {
  font-size: 1.2rem;
  color: #4f46e5;
}
.song-info-next {
  font-size: 0.9rem;
  color: #6b7280;
  font-style: italic;
  margin-top: 0.3rem;
}
        .drop-zone {
  border: 2px dashed #6366f1;
  padding: 20px;
  text-align: center;
  border-radius: 12px;
  cursor: pointer;
  transition: background 0.2s;
  color: #4f46e5;
}
.drop-zone:hover {
  background: #eef2ff;
}
        body > script:not([src]) {
  display: none;
}




        
    </style>
</head>
<body class="bg-gray-100 p-5 flex items-center justify-center min-h-screen">
    <!-- Modal para ver im√°genes en grande -->
    <div id="imageModal" class="modal">
        <span class="close-modal">&times;</span>
        <div class="modal-content">
            <img id="modalImage" class="modal-image" src="" alt="Imagen ampliada">
        </div>
    </div>

    <div class="container rounded-xl shadow-xl flex flex-col">
        <h1 class="text-4xl font-extrabold text-gray-900 mb-8 text-center">Javier Santiago Gast√≥n de Iriarte Cabrera</h1>

        <!-- Nueva pesta√±a en navegaci√≥n principal -->
        <nav class="flex border-b border-gray-200 -mt-8 mb-8 overflow-x-auto">
          <button class="main-tab-button" data-main-tab="home">Inicio</button>
          <button class="main-tab-button" data-main-tab="diary">Diario</button>
          <button class="main-tab-button" data-main-tab="maps">Mapas de Recorridos</button>
          <button class="main-tab-button" data-main-tab="trips">Organizar Viajes</button>
          <button class="main-tab-button" data-main-tab="menus">Men√∫s de Comida</button>
          <button class="main-tab-button" data-main-tab="projects">Proyectos</button>
          <button class="main-tab-button" data-main-tab="profile">Perfil</button> <!-- Nueva pesta√±a -->
          <button class="main-tab-button" data-main-tab="radio">Radio</button>
            <button class="main-tab-button" data-main-tab="stories">Stories</button>

        </nav>

        <div id="mainHomeSection" class="main-tab-content">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Bienvenido a mi p√°gina Personal</h2>
            <p class="text-center text-gray-600 mb-8">Explora las pesta√±as de arriba.</p>
            
            <h3 class="text-xl font-semibold text-gray-700 mb-4">√öltima Entrada del Diario:</h3>
            <div id="latestEntryContent" class="text-gray-700">
                <p class="text-center text-gray-500">Cargando √∫ltima entrada del diario...</p>
            </div>
            <div class="flex justify-center mt-8">
                <button onclick="showMainTab('diary'); showDiarySubTab('write')" class="btn py-3 px-6 rounded-lg text-lg">
                    <span>Ir al Diario</span>
                </button>
            </div>

            <hr class="my-6">
<h3 class="text-xl font-semibold text-gray-700 mb-4">√öltima Historia Publicada:</h3>
<div id="latestStoryContent" class="text-gray-700">
    <p class="text-center text-gray-500">Cargando √∫ltima historia...</p>
</div>




            
        </div>

        <div id="mainDiarySection" class="main-tab-content hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Mi Diario Digital</h2>
            
            <nav class="flex border-b border-gray-200 mb-6">
                <button class="diary-sub-tab-button active" data-diary-sub-tab="write">Escribir Entrada</button>
                <button class="diary-sub-tab-button" data-diary-sub-tab="view">Ver/Buscar Entradas</button>
            </nav>

            <div id="diaryWriteEntrySection" class="diary-sub-tab-content">
                <form id="diaryForm" class="w-full">
                    <div class="mb-6">
                      <label for="title" class="form-label mb-2">T√≠tulo de la Entrada:</label>
                      <input type="text" id="title" name="title" class="form-input rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Ej: Paseo por el parque" />
                    </div>
                    <div class="mb-6">
                        <label for="text" class="form-label mb-2">Tu Entrada de Hoy:</label>
                        <textarea id="text" name="text" rows="8" class="form-textarea rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="¬øQu√© te ha pasado hoy? Escribe aqu√≠ tu historia..."></textarea>
                    </div>

                    <div class="mb-4">
  <label class="form-label mb-2">Arrastra una imagen aqu√≠ o haz clic para elegir:</label>
  <div id="diaryDropZone" class="drop-zone">
    Suelta tu imagen aqu√≠ o haz clic para seleccionarla
    <input type="file" id="photoUpload" hidden accept="image/*" />
  </div>
  <p class="text-sm text-gray-500 mt-1">Se subir√° a tu Google Drive. Tama√±o m√°ximo: 5MB.</p>
</div>


                    <div class="mb-8">
                        <label for="externalImageUrl" class="form-label mb-2">
  O pegar <strong>URL de imagen</strong> desde servicios como:
</label>
<div class="flex flex-wrap gap-2 mb-2">
  <a href="https://es.imgbb.com/" target="_blank" class="text-blue-600 underline hover:text-blue-800">ImgBB</a>
  <a href="https://pasteboard.co/" target="_blank" class="text-blue-600 underline hover:text-blue-800">Pasteboard</a>
  <a href="https://postimages.org/" target="_blank" class="text-blue-600 underline hover:text-blue-800">Postimages</a>
  <a href="https://imgur.com/" target="_blank" class="text-blue-600 underline hover:text-blue-800">Imgur</a>
</div>

<input
  type="url"
  id="externalImageUrl"
  name="externalImageUrl"
  class="form-input rounded-lg focus:ring-blue-500 focus:border-blue-500"
  placeholder="Ej: https://ibb.co/ABC123 o https://i.imgur.com/ejemplo.jpg"
/>
<p class="text-sm text-gray-500 mt-1">Se procesar√° autom√°ticamente si es compatible.</p>

                    </div>

                    <div id="messageBox" class="message-box w-full"></div>

                    <button type="submit" class="btn w-full">
                        <span id="buttonText">Guardar Entrada</span>
                        <div id="loadingSpinner" class="loading-spinner"></div>
                    </button>
                </form>
            </div>

            <div id="diaryViewSearchSection" class="diary-sub-tab-content hidden">
                
                <div class="flex gap-2 items-end mb-6">
                  <div class="flex-1">
                    <label for="searchTitle" class="form-label mb-2">Buscar por T√≠tulo:</label>
                    <input type="text" id="searchTitle" name="searchTitle" class="form-input rounded-lg" placeholder="Palabra clave del t√≠tulo">
                  </div>
                  <button onclick="buscarPorTitulo()" class="btn px-6 py-3">Buscar</button>
                </div>

                <h3 class="text-xl font-semibold text-gray-700 mb-4">Buscar Entradas por Fecha</h3>
                <div class="flex flex-col sm:flex-row items-center justify-center gap-4 mb-8">
                    <div>
                        <label for="startDate" class="form-label">Desde:</label>
                        <input type="datetime-local" id="startDate" class="form-input w-auto">
                    </div>
                    <div>
                        <label for="endDate" class="form-label">Hasta:</label>
                        <input type="datetime-local" id="endDate" class="form-input w-auto">
                    </div>
                    <button id="searchEntriesBtn" class="btn mt-6 sm:mt-0 px-6 py-3">Buscar</button>
                </div>
                <div id="searchResults" class="text-gray-700">
                    <p class="text-center text-gray-500">Usa el filtro de fechas para buscar entradas.</p>
                </div>
            </div>
        </div>

        <div id="mainMapsSection" class="main-tab-content hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Mapas de Recorridos</h2>
            <!-- Sustituir el contenido del div con id="mainMapsSection" en tu HTML -->

            
              <div class="flex gap-4 mb-4">
                <input type="datetime-local" id="mapStartDate" class="form-input" value="2025-06-21T00:00">
                <input type="datetime-local" id="mapEndDate" class="form-input" value="2025-06-22T23:59">

                <button onclick="filtrarDatosMapa()" class="btn">Aplicar Filtros</button>
              </div>
            
              <div id="mapid" style="height: 500px;" class="mb-6 rounded-xl shadow-md"></div>
            
              <h3 class="text-xl font-semibold text-gray-700 mb-2">Datos Recopilados</h3>
              <div class="overflow-auto max-h-[400px] border rounded-lg shadow">
                <table class="w-full text-sm text-left">
                  <thead class="bg-gray-100">
                    <tr>
                      <th class="px-4 py-2">Fecha</th>
                      <th class="px-4 py-2">Hora</th>
                      <th class="px-4 py-2">Lat</th>
                      <th class="px-4 py-2">Lon</th>
                      <th class="px-4 py-2">Alt</th>
                      <th class="px-4 py-2">Pulso</th>
                      <th class="px-4 py-2">SpO2</th>
                      <th class="px-4 py-2">Pasos</th>
                      <th class="px-4 py-2">Temp</th>
                      <th class="px-4 py-2">Anomal√≠a</th>
                    </tr>
                  </thead>
                  <tbody id="tablaDatosMapa"></tbody>
                </table>
              </div>
          

        </div>

        <div id="mainTripsSection" class="main-tab-content hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Organizar Viajes</h2>
            <p class="text-center text-gray-600">Planifica tus viajes, rutas y presupuestos. ¬°Pr√≥ximamente!</p>
            <p class="text-center text-gray-500 mt-4">Puedes a√±adir formularios y listas para gestionar tus planes de viaje.</p>
        </div>

        <div id="mainMenusSection" class="main-tab-content hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Men√∫s de Comida</h2>
            <p class="text-center text-gray-600">Organiza tus comidas semanales y listas de la compra. ¬°Paciencia, pronto estar√° listo!</p>
            <p class="text-center text-gray-500 mt-4">Aqu√≠ podr√≠as tener un calendario, recetas y opciones de filtrado.</p>
        </div>

        <div id="mainProjectsSection" class="main-tab-content hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Gesti√≥n de Proyectos</h2>
            <p class="text-center text-gray-600">Gestiona tus tareas, plazos y objetivos de tus proyectos personales o profesionales. ¬°Trabajando en ello!</p>
            <p class="text-center text-gray-500 mt-4">Tableros Kanban o listas de tareas ser√≠an √∫tiles aqu√≠.</p>
        </div>

        <!-- Nueva secci√≥n "Perfil" -->
        <div id="mainProfileSection" class="main-tab-content hidden">
          <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Perfil Personal</h2>
          <div class="space-y-4">
            <p><strong>Nombre:</strong> Javier Santiago Gast√≥n de Iriarte Cabrera</p>
            <p><strong>DNI:</strong> 47033535F</p>
            <p><strong>Contacto:</strong> <a href="mailto:javier@email.com" class="text-blue-600 underline">jsgastoniriartecabrera@gmail.com</a></p>
            <p><strong>Tel√©fono:</strong> +34 669 574 483</p>
            <p><strong>Direcci√≥n:</strong> Ab el Hamet 4-6, esc. der, 1¬∫F, Alicante, 03003, Alicante, SPAIN</p>
            <p><strong>Sobre m√≠:</strong> Soy javi, me aburro mucho.</p>
              <img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=https://jsgaston.github.io/" alt="QR de Javi">

          </div>
        </div>

        <!-- Secci√≥n de Radio -->
        <div id="mainRadioSection" class="main-tab-content hidden">
    <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">üéß Mi Radio</h2>
    <button onclick="obtenerLetraDesdeAppScript()" class="radio-button">üìú Ver Letra</button>
<div id="letraCancion" class="mt-4 p-3 rounded-md bg-white text-sm text-gray-800 whitespace-pre-line shadow hidden relative">
  <button onclick="document.getElementById('letraCancion').classList.add('hidden')" 
          class="absolute top-2 right-2 bg-red-500 text-white rounded-full px-3 py-1 text-xs hover:bg-red-600">
    ‚úñ Cerrar
  </button>
  <div id="letraTexto"></div>
</div>
            <p class="text-center text-gray-500 mt-4"></p>



    <!-- Canci√≥n actual -->
    <div class="song-info-box text-center mb-4">
      <div class="song-info-title">üéµ Sonando ahora:</div>
      <div id="currentSong" class="song-info-content">---</div>
      <div id="nextSong" class="song-info-next">Siguiente: ---</div>
    </div>

    <!-- Reproductor + botones -->
    <div class="flex flex-col items-center gap-3 my-8">
      <div class="flex justify-center w-full px-4">
        <div style="display: flex; justify-content: center; width: 100%;">
          <audio id="audio" controls style="width: 100%; max-width: 1000px; padding: 8px; background: white; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.2);"></audio>
        </div>
      </div>
         <p class="text-center text-gray-500 mt-4"></p>
      <div class="flex flex-wrap gap-4 justify-center">
        <button onclick="prevTrack()" class="radio-button">‚èÆÔ∏è Anterior</button>
        <button onclick="nextTrack()" class="radio-button">‚è≠Ô∏è Siguiente</button>
        <button id="shuffleBtn" onclick="toggleShuffle()" class="radio-button bg-gray-300 text-gray-800">üîÄ Shuffle</button>
        <button id="repeatBtn" onclick="toggleRepeat()" class="radio-button bg-gray-300 text-gray-800">üîÅ Repeat</button>
      </div>
    </div>

    <!-- Lista visible -->
    <ul id="songList" class="list-disc px-6 text-left text-gray-800 space-y-1 mb-6"></ul>

    <!-- Lista desplegable completa -->
    <div class="text-center mb-6">
      <label for="fullSongSelect" class="block mb-1 font-medium text-gray-700">Seleccionar canci√≥n de la lista completa:</label>
      <select id="fullSongSelect" class="form-input w-full max-w-md mx-auto rounded-md border border-gray-300">
        <option disabled selected>-- Elegir canci√≥n --</option>
      </select>
    </div>

  <p class="text-center text-gray-500 mt-4"></p>

<div id="dropZone" class="drop-zone">
  Arrastra tu canci√≥n aqu√≠ o haz clic para elegir
  <input type="file" id="uploader" hidden accept="audio/*">
</div>

<p id="resultado"></p>



</div>
            
  


        <!--  Secci√≥n para Historias -->
<div id="mainStoriesSection" class="main-tab-content hidden">
  <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Mis Historias</h2>

  <input type="text" id="storyTitle" placeholder="T√≠tulo de la historia" class="form-input mb-4">
  <div id="storyEditor" style="height: 300px;" class="mb-4 border border-gray-300 rounded-md p-4 bg-white"></div>

  <button class="btn" onclick="guardarHistoria()">Guardar Historia</button>
  <div id="storyMessage" class="message-box mt-4 hidden"></div>

  <hr class="my-6">

    <h3 class="text-xl font-semibold text-gray-700 mb-4">Buscar Historias</h3>
<div class="flex flex-col md:flex-row md:items-end gap-4 mb-6">
  <div class="flex-1">
    <label for="searchKeyword" class="form-label">Buscar por palabra clave:</label>
    <input type="text" id="searchKeyword" class="form-input rounded-lg" placeholder="Escribe una palabra del t√≠tulo o contenido">
  </div>
  <div>
    <label for="searchStartDate" class="form-label">Desde:</label>
    <input type="date" id="searchStartDate" class="form-input">
  </div>
  <div>
    <label for="searchEndDate" class="form-label">Hasta:</label>
    <input type="date" id="searchEndDate" class="form-input">
  </div>
  <div>
    <button onclick="buscarHistorias()" class="btn">üîç Buscar</button>
  </div>
</div>

<div id="searchStoryResults">
  <p class="text-center text-gray-500">Usa el buscador para encontrar historias.</p>
</div>

<hr class="my-6">
<h3 class="text-xl font-semibold text-gray-700 mb-4">Historias Guardadas</h3>
<div id="storyList"></div>



</div>


            


    <script>
        // ¬°IMPORTANTE! Reemplaza este URL con el URL de tu Google Apps Script desplegado.
        const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbykJTypKfvu-NyjwspsAGIxjYqEz0vGfBq-Si5wx4HFgG-5wEIXRD4159yIOVuaVHw8cg/exec'; 

        // Elementos del DOM para la navegaci√≥n principal
        const mainTabButtons = document.querySelectorAll('.main-tab-button');
        const mainHomeSection = document.getElementById('mainHomeSection');
        const mainDiarySection = document.getElementById('mainDiarySection');
        const mainMapsSection = document.getElementById('mainMapsSection');
        const mainTripsSection = document.getElementById('mainTripsSection');
        const mainMenusSection = document.getElementById('mainMenusSection');
        const mainProjectsSection = document.getElementById('mainProjectsSection');

        // Elementos del DOM para la sub-navegaci√≥n del Diario
        const diarySubTabButtons = document.querySelectorAll('.diary-sub-tab-button');
        const diaryWriteEntrySection = document.getElementById('diaryWriteEntrySection');
        const diaryViewSearchSection = document.getElementById('diaryViewSearchSection');

        // Elementos del DOM para la l√≥gica del Diario
        const latestEntryContent = document.getElementById('latestEntryContent');
        const searchEntriesBtn = document.getElementById('searchEntriesBtn');
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        const searchResultsDiv = document.getElementById('searchResults');
        const diaryForm = document.getElementById('diaryForm');
        const text = document.getElementById('text');
        const photoUpload = document.getElementById('photoUpload');
        const externalImageUrlInput = document.getElementById('externalImageUrl');
        const messageBox = document.getElementById('messageBox');
        const buttonText = document.getElementById('buttonText');
        const loadingSpinner = document.getElementById('loadingSpinner');

        // Elementos del modal
        const imageModal = document.getElementById('imageModal');
        const modalImage = document.getElementById('modalImage');
        const closeModal = document.querySelector('.close-modal');



text.addEventListener('paste', function (event) {
    const items = (event.clipboardData || event.originalEvent.clipboardData).items;
    for (const item of items) {
        if (item.type.indexOf("image") !== -1) {
            const file = item.getAsFile();
            const reader = new FileReader();
            reader.onload = function (evt) {
                // ‚úÖ Pegamos la imagen base64 en un campo oculto
                document.getElementById('externalImageUrl').value = ''; // evitar conflicto
                window._diaryPastedImage = evt.target.result;
                showMessage("Imagen pegada desde el portapapeles (se subir√° al guardar).", "success");
            };
            reader.readAsDataURL(file);
        }
    }
});

const diaryDropZone = document.getElementById("diaryDropZone");

// Abrir selector de archivos al hacer clic
diaryDropZone.addEventListener("click", () => photoUpload.click());

// Cambiar estilo al arrastrar
diaryDropZone.addEventListener("dragover", e => {
  e.preventDefault();
  diaryDropZone.style.background = "#ddd6fe";
});
diaryDropZone.addEventListener("dragleave", () => {
  diaryDropZone.style.background = "";
});

// Manejar el drop
diaryDropZone.addEventListener("drop", e => {
  e.preventDefault();
  diaryDropZone.style.background = "";
  const files = e.dataTransfer.files;
  if (files.length > 0) {
    photoUpload.files = files;
    showMessage("üì§ Imagen cargada desde drag & drop.", "success");
  }
});



        

        // --- Funciones de Utilidad ---

        // Funci√≥n para mostrar mensajes al usuario (√©xito/error)
        function showMessage(message, type) {
            messageBox.textContent = message;
            messageBox.className = `message-box w-full ${type}`;
            messageBox.style.display = 'block';
        }

        // Funci√≥n para ocultar mensajes
        function hideMessage() {
            messageBox.style.display = 'none';
            messageBox.textContent = '';
            messageBox.className = 'message-box w-full';
        }

        // Funci√≥n auxiliar para leer un archivo como Base64
        function readFileAsBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        // Funci√≥n para resetear el estado del formulario
        function resetFormState() {
            buttonText.textContent = 'Guardar Entrada';
            loadingSpinner.style.display = 'none';
            diaryForm.querySelector('button[type="submit"]').disabled = false;
        }

        // Funci√≥n para formatear la fecha
        function formatDate(dateString) {
            const options = { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' };
            try {
                return new Date(dateString).toLocaleDateString('es-ES', options);
            } catch (e) {
                return dateString;
            }
        }

        // Funci√≥n mejorada para convertir URLs de servicios de hosting a URLs directas (cliente)
        function convertToDirectImageUrl(url) {
            if (!url || url.trim() === '') return null;
        
            const cleanUrl = url.trim();
        
            // Si ya es directa, √∫sala
            if (cleanUrl.match(/\.(jpg|jpeg|png|gif|webp)(\?.*)?$/i) ||
                cleanUrl.includes('drive.google.com/thumbnail') ||
                cleanUrl.includes('i.ibb.co') ||
                cleanUrl.includes('i.imgur.com') ||
                cleanUrl.includes('i.postimg.cc')) {
                return cleanUrl;
            }
        
            // pasteboard.co
            const pasteboard = cleanUrl.match(/pasteboard\.co\/([a-zA-Z0-9]+)(\.[a-z]+)?/);
            if (pasteboard) {
                return `https://pasteboard.co/${pasteboard[1]}.png`;
            }
        
            // imgbb
            const imgbb = cleanUrl.match(/ibb\.co\/([a-zA-Z0-9]+)/);
            if (imgbb) {
                return `https://i.ibb.co/${imgbb[1]}/image.png`;
            }
        
            // imgur
            const imgur = cleanUrl.match(/imgur\.com\/(?:a\/)?([a-zA-Z0-9]+)/);
            if (imgur) {
                return `https://i.imgur.com/${imgur[1]}.jpg`;
            }
        
            // postimages
            const postimg = cleanUrl.match(/postimg\.cc\/([a-zA-Z0-9]+)/);
            if (postimg) {
                return `https://i.postimg.cc/${postimg[1]}/image.jpg`;
            }
        
            return cleanUrl;
        }
        


        // Funci√≥n para intentar m√∫ltiples URLs de imagen
        function tryMultipleImageUrls(originalUrl, imgElement, callback) {
            const urls = [];
        
            const directUrl = convertToDirectImageUrl(originalUrl);
            if (directUrl) urls.push(directUrl);
        
            // Agregar variantes por host
            const imgbb = originalUrl.match(/ibb\.co\/([a-zA-Z0-9]+)/);
            if (imgbb) {
                const base = `https://i.ibb.co/${imgbb[1]}`;
                urls.push(`${base}/image.png`, `${base}/image.jpg`, `${base}/image.webp`);
            }
        
            const pasteboard = originalUrl.match(/pasteboard\.co\/([a-zA-Z0-9]+)/);
            if (pasteboard) {
                const base = `https://pasteboard.co/${pasteboard[1]}`;
                urls.push(`${base}.png`, `${base}.jpg`, `${base}.webp`);
            }
        
            const imgur = originalUrl.match(/imgur\.com\/(?:a\/)?([a-zA-Z0-9]+)/);
            if (imgur) {
                urls.push(`https://i.imgur.com/${imgur[1]}.jpg`);
            }
        
            const postimg = originalUrl.match(/postimg\.cc\/([a-zA-Z0-9]+)/);
            if (postimg) {
                const base = `https://i.postimg.cc/${postimg[1]}`;
                urls.push(`${base}/image.jpg`, `${base}/image.png`, `${base}/image.webp`);
            }
        
            let index = 0;
        
            function tryNextUrl() {
                if (index >= urls.length) {
                    callback(false); // ninguna funcion√≥
                    return;
                }
        
                const testUrl = urls[index];
                const testImg = new Image();
                testImg.onload = () => {
                    imgElement.src = testUrl;
                    callback(true);
                };
                testImg.onerror = () => {
                    index++;
                    tryNextUrl();
                };
                testImg.src = testUrl;
            }
        
            tryNextUrl();
        }


        

        // Funci√≥n para renderizar una entrada de diario con mejor manejo de im√°genes
        function renderEntry(entry, containerElement) {
                        
            const entryCard = document.createElement('div');
            entryCard.className = 'entry-card';

            const titleElem = document.createElement('h3');
            titleElem.className = 'text-xl font-bold text-indigo-700 mb-2';
            titleElem.textContent = entry.title || '(Sin t√≠tulo)';
            entryCard.appendChild(titleElem);


            const datePara = document.createElement('p');
            datePara.className = 'text-sm text-gray-500 mb-2';
            datePara.textContent = `Fecha: ${formatDate(entry.timestamp)}`;
            entryCard.appendChild(datePara);

            const textPara = document.createElement('p');
            textPara.className = 'text-base text-gray-800 whitespace-pre-wrap';
            textPara.textContent = entry.text;
            entryCard.appendChild(textPara);

            // Verificar si hay una URL de foto v√°lida
            if (entry.photoUrl && entry.photoUrl !== 'No hay foto' && !entry.photoUrl.startsWith('Error')) {
                const imageContainer = document.createElement('div');
                imageContainer.className = 'mt-4';
                
                const loadingIndicator = document.createElement('div');
                loadingIndicator.innerHTML = '<span class="image-loading"></span>Cargando imagen...';
                loadingIndicator.className = 'text-sm text-gray-500 flex items-center';
                imageContainer.appendChild(loadingIndicator);
                
                const img = document.createElement('img');
                img.className = 'mt-4 rounded-lg shadow-md hidden';
                img.alt = 'Foto de la entrada del diario';
                
                // A√±adir evento de clic para mostrar en modal
                img.addEventListener('click', function() {
                    modalImage.src = this.src;
                    imageModal.style.display = 'block';
                });
                
                imageContainer.appendChild(img);
                entryCard.appendChild(imageContainer);
                
                // Intentar cargar la imagen con m√∫ltiples URLs si es necesario
                tryMultipleImageUrls(entry.photoUrl, img, function(success) {
                    loadingIndicator.style.display = 'none';
                    if (success) {
                        img.classList.remove('hidden');
                    } else {
                        const errorPara = document.createElement('p');
                        errorPara.className = 'text-sm text-red-500 mt-2';
                        errorPara.textContent = 'No se pudo cargar la imagen';
                        imageContainer.appendChild(errorPara);
                    }
                });
                
            } else if (entry.photoUrl && entry.photoUrl.startsWith('Error')) {
                const errorPara = document.createElement('p');
                errorPara.className = 'text-sm text-red-500 mt-2';
                errorPara.textContent = `Error con la foto: ${entry.photoUrl}`;
                entryCard.appendChild(errorPara);
            }

            containerElement.appendChild(entryCard);
        }

        // Event listeners para el modal
        closeModal.addEventListener('click', function() {
            imageModal.style.display = 'none';
        });

        imageModal.addEventListener('click', function(e) {
            if (e.target === imageModal) {
                imageModal.style.display = 'none';
            }
        });

        // --- Funciones de Navegaci√≥n Principal ---

function showMainTab(tabName) {
    // Ocultar todas las secciones
    mainHomeSection.classList.add('hidden');
    mainDiarySection.classList.add('hidden');
    mainMapsSection.classList.add('hidden');
    mainTripsSection.classList.add('hidden');
    mainMenusSection.classList.add('hidden');
    mainProjectsSection.classList.add('hidden');
    document.getElementById('mainProfileSection').classList.add('hidden'); // <-- ESTA L√çNEA ES NECESARIA
    document.getElementById('mainRadioSection').classList.add('hidden');
    document.getElementById('mainStoriesSection').classList.add('hidden');


    // Activar la pesta√±a correspondiente
    mainTabButtons.forEach(button => button.classList.remove('active'));

            // Mostrar la secci√≥n correspondiente
            if (tabName === 'home') {
                mainHomeSection.classList.remove('hidden');
                document.querySelector('[data-main-tab="home"]').classList.add('active');
                loadLatestEntry();
                loadLatestStory();
            } else if (tabName === 'diary') {
                mainDiarySection.classList.remove('hidden');
                document.querySelector('[data-main-tab="diary"]').classList.add('active');
                showDiarySubTab('write');
            } else if (tabName === 'maps') {
              mainMapsSection.classList.remove('hidden');
              document.querySelector('[data-main-tab="maps"]').classList.add('active');
              setTimeout(() => {
                if (!mapa) iniciarMapa(); else mapa.invalidateSize();
              }, 300);
            } else if (tabName === 'trips') {
                mainTripsSection.classList.remove('hidden');
                document.querySelector('[data-main-tab="trips"]').classList.add('active');
            } else if (tabName === 'menus') {
                mainMenusSection.classList.remove('hidden');
                document.querySelector('[data-main-tab="menus"]').classList.add('active');
            } else if (tabName === 'projects') {
                mainProjectsSection.classList.remove('hidden');
                document.querySelector('[data-main-tab="projects"]').classList.add('active');
            }  else if (tabName === 'profile') {
    document.getElementById('mainProfileSection').classList.remove('hidden');
    document.querySelector('[data-main-tab="profile"]').classList.add('active');
            }  else if (tabName === 'radio') {
    document.getElementById('mainRadioSection').classList.remove('hidden');
    document.querySelector('[data-main-tab="radio"]').classList.add('active');
}
    else if (tabName === 'stories') {
    document.getElementById('mainStoriesSection').classList.remove('hidden');
    document.querySelector('[data-main-tab="stories"]').classList.add('active');
    cargarHistorias(); // opcional: para cargar historias al entrar
}



            hideMessage();
        }

        // Event listeners para los botones de las pesta√±as principales
        mainTabButtons.forEach(button => {
            button.addEventListener('click', () => {
                showMainTab(button.dataset.mainTab);
            });
        });

        
        // --- Funciones de Sub-navegaci√≥n del Diario ---

        function showDiarySubTab(subTabName) {
            // Ocultar todas las sub-secciones
            diaryWriteEntrySection.classList.add('hidden');
            diaryViewSearchSection.classList.add('hidden');

            // Desactivar todos los botones de sub-pesta√±a
            diarySubTabButtons.forEach(button => button.classList.remove('active'));

            // Mostrar la sub-secci√≥n correspondiente
            if (subTabName === 'write') {
                diaryWriteEntrySection.classList.remove('hidden');
                document.querySelector('[data-diary-sub-tab="write"]').classList.add('active');
            } else if (subTabName === 'view') {
                diaryViewSearchSection.classList.remove('hidden');
                document.querySelector('[data-diary-sub-tab="view"]').classList.add('active');
                searchResultsDiv.innerHTML = '<p class="text-center text-gray-500">Usa el filtro de fechas para buscar entradas.</p>';
            }
            hideMessage();
        }

        // Event listeners para los botones de las sub-pesta√±as del diario
        diarySubTabButtons.forEach(button => {
            button.addEventListener('click', () => {
                showDiarySubTab(button.dataset.diarySubTab);
            });
        });

        // --- Funciones del Diario ---

        async function loadLatestEntry() {
            latestEntryContent.innerHTML = '<p class="text-center text-gray-500">Cargando √∫ltima entrada del diario...</p>';
            try {
                const response = await fetch(`${GOOGLE_APPS_SCRIPT_URL}?action=getLatest`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const result = await response.json();

                if (result.status === 'success' && result.entry) {
                    latestEntryContent.innerHTML = '';
                    renderEntry(result.entry, latestEntryContent);
                } else {
                    latestEntryContent.innerHTML = `<p class="text-center text-gray-500">${result.message || 'No hay entradas para mostrar.'}</p>`;
                }
            } catch (error) {
                console.error('Error al cargar la √∫ltima entrada:', error);
                latestEntryContent.innerHTML = '<p class="text-center text-red-500">Error al cargar la √∫ltima entrada.</p>';
            }
        }


        async function loadLatestStory() {
  const latestStoryContent = document.getElementById('latestStoryContent');
  latestStoryContent.innerHTML = '<p class="text-center text-gray-500">Cargando √∫ltima historia...</p>';
  
  try {
    const response = await fetch(`${GOOGLE_APPS_SCRIPT_URL_STORIES}?action=listarHistorias`);
    const result = await response.json();

    if (result.status === 'success' && result.historias.length > 0) {
      const historia = result.historias[0]; // La m√°s reciente (ya viene invertida)
      const card = document.createElement("div");
      card.className = "entry-card mb-4";
      card.innerHTML = `
        <h4 class='font-bold text-indigo-600'>${historia.titulo}</h4>
        <p class='text-sm text-gray-500'>${new Date(historia.fecha).toLocaleString()}</p>
        <div class='prose max-w-none mt-2 bg-white p-4 rounded-md shadow-sm border'>${historia.contenido}</div>
      `;
      latestStoryContent.innerHTML = '';
      latestStoryContent.appendChild(card);
    } else {
      latestStoryContent.innerHTML = `<p class="text-center text-gray-500">${result.message || 'No hay historias disponibles.'}</p>`;
    }
  } catch (error) {
    console.error('Error al cargar la √∫ltima historia:', error);
    latestStoryContent.innerHTML = '<p class="text-center text-red-500">Error al cargar la historia.</p>';
  }
}






        

        // Env√≠o del formulario del diario
        diaryForm.addEventListener('submit', async (e) => {
            e.preventDefault();
        
            hideMessage();
            buttonText.textContent = 'Guardando...';
            loadingSpinner.style.display = 'block';
            diaryForm.querySelector('button[type="submit"]').disabled = true;
        
            const title = document.getElementById('title').value.trim();
            const entryText = text.value;
            const externalImageUrl = externalImageUrlInput.value.trim();
            let imageData = null;
            let imageName = '';
        
            if (!title) {
                showMessage('Por favor, pon un t√≠tulo a tu entrada.', 'error');
                resetFormState();
                return;
            }
        
            if (!entryText.trim()) {
                showMessage('Por favor, escribe algo en tu entrada del diario.', 'error');
                resetFormState();
                return;
            }

            if (photoUpload.files.length > 0 && window._diaryPastedImage) {
    showMessage('Por favor, elige solo una opci√≥n para la imagen: archivo o pegada.', 'error');
    resetFormState();
    return;
}

        
            if (photoUpload.files.length > 0 && externalImageUrl !== '') {
                showMessage('Por favor, elige SOLO UNA opci√≥n para la imagen.', 'error');
                resetFormState();
                return;
            }
        
            if (photoUpload.files.length > 0) {
                const file = photoUpload.files[0];
                if (file.size > 5 * 1024 * 1024) {
                    showMessage('La imagen es demasiado grande (m√°x. 5MB).', 'error');
                    resetFormState();
                    return;
                }
                imageName = file.name;
                try {
                    imageData = await readFileAsBase64(file);
                } catch (error) {
                    showMessage('Error al leer la imagen.', 'error');
                    resetFormState();
                    return;
                }
            }
        
            const formData = new FormData();
               
                formData.append('title', title);           // Campo 1: T√≠tulo
                formData.append('diaryEntry', entryText);  // Campo 2: Texto del diario
                
                if (externalImageUrl !== '') {
                  formData.append('externalImageUrl', externalImageUrl);
                    } else if (window._diaryPastedImage) {
  formData.append('imageData', window._diaryPastedImage);
  formData.append('imageName', 'imagen_pegada.png');

                } else if (imageData) {
                  formData.append('imageData', imageData);
                  formData.append('imageName', imageName);
                }


        
            try {
                const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
                    method: 'POST',
                    body: formData,
                });
        
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
        
                const result = await response.json();
        
                if (result.status === 'success') {
                    showMessage('¬°Entrada guardada con √©xito!', 'success');
                    text.value = '';
                    window._diaryPastedImage = null;

                    photoUpload.value = '';
                    externalImageUrlInput.value = '';
                    document.getElementById('title').value = ''; // limpiar t√≠tulo
                } else {
                    showMessage(`Error al guardar: ${result.message || 'Error desconocido'}`, 'error');
                }
            } catch (error) {
                console.error('Error al enviar la entrada:', error);
                showMessage('Error al conectar con el servidor.', 'error');
            } finally {
                resetFormState();
            }
        });


        // B√∫squeda de entradas por fecha
        searchEntriesBtn.addEventListener('click', async () => {
            const startDate = startDateInput.value;
            const endDate = endDateInput.value;

            if (!startDate || !endDate) {
                showMessage('Por favor, selecciona tanto la fecha de inicio como la de fin para buscar.', 'error');
                return;
            }

            if (new Date(startDate) > new Date(endDate)) {
                showMessage('La fecha de inicio no puede ser posterior a la fecha de fin.', 'error');
                return;
            }

            searchResultsDiv.innerHTML = '<p class="text-center text-gray-500">Buscando entradas...</p>';
            hideMessage();

            try {
                const response = await fetch(`${GOOGLE_APPS_SCRIPT_URL}?action=getEntriesByDate&startDate=${startDate}&endDate=${endDate}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const result = await response.json();

                if (result.status === 'success' && result.entries && result.entries.length > 0) {
                    searchResultsDiv.innerHTML = '';
                    result.entries.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    result.entries.forEach(entry => renderEntry(entry, searchResultsDiv));
                } else {
                    searchResultsDiv.innerHTML = `<p class="text-center text-gray-500">${result.message || 'No se encontraron entradas para el rango de fechas seleccionado.'}</p>`;
                }
            } catch (error) {
                console.error('Error al buscar entradas:', error);
                searchResultsDiv.innerHTML = '<p class="text-center text-red-500">Error al buscar entradas. Int√©ntalo de nuevo.</p>';
            }
        });

        // --- Inicializaci√≥n ---
        document.addEventListener('DOMContentLoaded', () => {
            showMainTab('home');
        });
    </script>
    <!-- Insertar al final del <body>, antes del cierre -->
    <script>
      const SERVER_DATA_URL = "https://script.google.com/macros/s/AKfycbwXNtcVnXevJgk-fpMvqqkc4BeSbZZ_EutueaCAkakIaBK5sx7AQL-fZpN5R08uWNy3/exec";
      let mapa, capaMarcadores, ruta, datosCargados = [];
    
      function iniciarMapa() {
        mapa = L.map("mapid").setView([40.4168, -3.7038], 5);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          attribution: '&copy; OpenStreetMap',
        }).addTo(mapa);
    
        capaMarcadores = L.featureGroup().addTo(mapa);
        ruta = L.polyline([], { color: 'blue' }).addTo(mapa);
        cargarDatosMapa();
      }
    
      async function cargarDatosMapa() {
        try {
          const res = await fetch(SERVER_DATA_URL);
          const datos = await res.json();
    
          if (!Array.isArray(datos) || datos.length === 0) {
            console.warn("No se recibieron datos v√°lidos.");
            document.getElementById("tablaDatosMapa").innerHTML = '<tr><td colspan="9" class="px-4 py-2 text-center text-gray-500">No hay datos disponibles</td></tr>';
            return;
          }
    
          datosCargados = datos;
          procesarYMostrarDatos(datos);
        } catch (error) {
          console.error("Error al obtener datos:", error);
          document.getElementById("tablaDatosMapa").innerHTML = '<tr><td colspan="9" class="px-4 py-2 text-center text-red-500">Error al obtener datos</td></tr>';
        }
      }
    
      function procesarYMostrarDatos(datos) {
        const cuerpoTabla = document.getElementById("tablaDatosMapa");
        cuerpoTabla.innerHTML = "";
        capaMarcadores.clearLayers();
        ruta.setLatLngs([]);
        const coordenadasRuta = [];
    
        datos.forEach((dato) => {
          const { Timestamp, Hour, Latitude, Longitude, Altitude, Pulse, SpO2, Steps, Temperature } = dato;
    
          if (!Latitude || !Longitude || !Altitude) return;
          const lat = parseFloat(Latitude);
          const lon = parseFloat(Longitude);
          const alt = parseFloat(Altitude);
          coordenadasRuta.push([lat, lon, alt]);
    
          const anomal√≠a =
            Pulse < 40 || Pulse > 120 ||
            SpO2 < 90 || SpO2 > 100 ||
            Temperature < 35.0 || Temperature > 37.5 ? "‚ö†Ô∏è" : "";
    
          const fila = `<tr>
            <td class="px-4 py-1">${new Date(Timestamp).toLocaleDateString()}</td>
          

            <td class="px-4 py-1">${new Date(Timestamp).toLocaleTimeString("es-ES", { hour: "2-digit", minute: "2-digit" })}</td>

            <td class="px-4 py-1">${lat.toFixed(4)}</td>
            <td class="px-4 py-1">${lon.toFixed(4)}</td>
            <td class="px-4 py-1">${alt.toFixed(1)}</td>
            <td class="px-4 py-1">${Pulse}</td>
            <td class="px-4 py-1">${SpO2}</td>
            <td class="px-4 py-1">${Steps}</td>
            <td class="px-4 py-1">${Temperature}</td>
            <td class="px-4 py-1">${anomal√≠a}</td>
          </tr>`;
          cuerpoTabla.insertAdjacentHTML("beforeend", fila);
    
          const fecha = new Date(Timestamp);
            const hora = fecha.toLocaleTimeString("es-ES", { hour: "2-digit", minute: "2-digit" });
            
            const marker = L.marker([lat, lon]).bindPopup(
              `üïí ${hora}<br/>ü´Ä Pulso: ${Pulse}<br/>üß™ SpO2: ${SpO2}<br/>üå° Temp: ${Temperature}`
            );

          capaMarcadores.addLayer(marker);
        });
    
        ruta.setLatLngs(coordenadasRuta);
        if (coordenadasRuta.length > 0) mapa.fitBounds(ruta.getBounds());
      }
    
      function filtrarDatosMapa() {
        const desde = new Date(document.getElementById("mapStartDate").value);
        const hasta = new Date(document.getElementById("mapEndDate").value);


        if (!datosCargados.length || isNaN(desde) || isNaN(hasta)) return;
    
        const filtrados = datosCargados.filter(d => {
          const fecha = new Date(d.Timestamp);
          return fecha >= desde && fecha <= hasta;
        });
        procesarYMostrarDatos(filtrados);
      }
    </script>

    <script>
        function normalize(str) {
          try {
            return (str || '').toString().normalize('NFD').replace(/[\u0300-\u036f]/g, '').trim().toLowerCase();
          } catch (e) {
            Logger.log('‚ùå Error en normalizar(): ' + e.message + ' | Valor: ' + str);
            return '';
          }
        }

        
        function buscarPorTitulo() {
          console.log('üü£ buscarPorTitulo() llamada');
        
          const raw = document.getElementById('searchTitle').value.trim();
          const keyword = normalize(raw);
          console.log('üî§ Palabra clave normalizada:', keyword);
        
          if (!keyword) {
            showMessage('Introduce una palabra clave para buscar.', 'error');
            return;
          }
        
          showMainTab('diary');
          diaryWriteEntrySection.classList.add('hidden');
          diaryViewSearchSection.classList.remove('hidden');
          diarySubTabButtons.forEach(button => button.classList.remove('active'));
          document.querySelector('[data-diary-sub-tab="view"]').classList.add('active');
        
          searchResultsDiv.innerHTML = '<p class="text-center text-gray-500">Buscando...</p>';
          hideMessage();
        
          const url = `${GOOGLE_APPS_SCRIPT_URL}?action=searchByTitle&keyword=${encodeURIComponent(keyword)}`;
          console.log('üåê Haciendo fetch a:', url);
        
          fetch(url)
            .then(res => res.json())
            .then(data => {
              console.log('üì¶ Respuesta recibida:', data);
              if (data.status === 'success' && data.entries.length > 0) {
                searchResultsDiv.innerHTML = '';
                data.entries.forEach(entry => {
                  console.log('‚úÖ Entrada recibida:', entry);
                  searchResultsDiv.innerHTML += `
                    <div style="border:1px solid #ccc; margin-bottom:1em; padding:1em;">
                      <strong>${entry.title}</strong><br>
                      <em>${entry.timestamp}</em><br>
                      <p>${entry.text}</p>
                      ${entry.photoUrl !== 'No hay foto' ? `<img src="${entry.photoUrl}" style="max-width:100%">` : ''}
                    </div>`;
                });
              } else {
                console.log('‚ö†Ô∏è No se encontraron entradas');
                searchResultsDiv.innerHTML = '<p class="text-center text-gray-500">No se encontraron coincidencias.</p>';
              }
            })
            .catch(err => {
              console.error('‚ùå Error en fetch:', err);
              showMessage('Error al buscar por t√≠tulo.', 'error');
            });
        }
    </script>

  

     <script>
          function mezclarYReproducir() {
            fetch('music_list.json')
              .then(response => response.json())
              .then(data => {
                playlist = data.map(song => song.url);
                shuffleArray(playlist);
                currentTrack = 0;
                playNextTrack();
              })
              .catch(error => console.error('Error al mezclar canciones:', error));
          }
    </script>

<script>
const audio = document.getElementById('audio');
    const songListElement = document.getElementById('songList');
    const currentSongSpan = document.getElementById('currentSong');
    const nextSongSpan = document.getElementById('nextSong');
    const fullSongSelect = document.getElementById('fullSongSelect');

    let songs = [];
    let currentTrack = 0;
    let isShuffling = false;
    let repeatMode = 'off'; // 'off', 'one', 'all'

    fetch('music_list.json')
      .then(res => res.json())
      .then(data => {
        songs = data;
        renderSongList();
        renderFullSelect();
        playTrack(0);
      })
      .catch(err => {
        currentSongSpan.textContent = 'Error al cargar canciones';
        console.error('Error:', err);
      });

    function renderSongList() {
      songListElement.innerHTML = '';
      const start = Math.max(currentTrack - 5, 0);
      const end = Math.min(currentTrack + 6, songs.length);

      for (let i = start; i < end; i++) {
        const li = document.createElement('li');
        li.innerHTML = (i === currentTrack ? 'üîä ' : '') + (songs[i].title || `Canci√≥n ${i + 1}`);
        li.classList.add('cursor-pointer', 'py-1', 'px-2', 'rounded-md');

        if (i === currentTrack) {
          li.classList.add('bg-indigo-100', 'text-indigo-700', 'border', 'border-indigo-400', 'font-bold');
        } else {
          li.classList.add('hover:bg-gray-100');
        }

        const song = songs[i];
        li.title = `Artista: ${song.artist}\n√Ålbum: ${song.album}\nG√©nero: ${song.genre}\nA√±o: ${song.year}\nDuraci√≥n: ${Math.floor(song.duration / 60)}:${String(song.duration % 60).padStart(2, '0')}`;

        li.onclick = () => playTrack(i);
        songListElement.appendChild(li);
      }
    }

    function renderFullSelect() {
      fullSongSelect.innerHTML = '<option disabled selected>-- Elegir canci√≥n --</option>';
      songs.forEach((song, i) => {
        const option = document.createElement('option');
        option.value = i;
        option.textContent = song.title || `Canci√≥n ${i + 1}`;
        fullSongSelect.appendChild(option);
      });
    }

    function playTrack(index) {
      if (!songs[index]) return;

      currentTrack = index;
      const song = songs[index];
      const next = songs[(index + 1) % songs.length];

      audio.src = song.url;
      currentSongSpan.textContent = `${song.title} - ${song.artist} (${song.genre})`;
      nextSongSpan.textContent = `Siguiente: ${next?.title} - ${next?.artist}`;

      audio.play().catch(err => console.error('Reproducci√≥n fallida:', err));
      audio.onloadedmetadata = () => {
        const duracion = audio.duration;
        audio.dataset.duracion = Math.round(duracion);
      };

      renderSongList();
      fullSongSelect.selectedIndex = index + 1; // +1 por el placeholder
    }

    function prevTrack() {
      currentTrack = (currentTrack - 1 + songs.length) % songs.length;
      playTrack(currentTrack);
    }

    function nextTrack() {
      if (repeatMode === 'one') {
        playTrack(currentTrack);
      } else if (isShuffling) {
        let next;
        do {
          next = Math.floor(Math.random() * songs.length);
        } while (songs.length > 1 && next === currentTrack);
        playTrack(next);
      } else {
        if (currentTrack + 1 < songs.length) {
          playTrack(currentTrack + 1);
        } else if (repeatMode === 'all') {
          playTrack(0);
        }
      }
    }

    audio.addEventListener('ended', nextTrack);

    fullSongSelect.addEventListener('change', (e) => {
      const index = parseInt(e.target.value);
      if (!isNaN(index)) playTrack(index);
    });

    function toggleShuffle() {
      isShuffling = !isShuffling;
      const shuffleBtn = document.getElementById('shuffleBtn');
      shuffleBtn.classList.toggle('bg-indigo-500', isShuffling);
      shuffleBtn.classList.toggle('text-white', isShuffling);
    }

    function toggleRepeat() {
      const btn = document.getElementById('repeatBtn');
      if (repeatMode === 'off') {
        repeatMode = 'all';
        btn.innerText = 'üîÅ Repeat All';
        btn.classList.replace('bg-gray-300', 'bg-indigo-500');
        btn.classList.replace('text-gray-800', 'text-white');
      } else if (repeatMode === 'all') {
        repeatMode = 'one';
        btn.innerText = 'üîÇ Repeat One';
      } else {
        repeatMode = 'off';
        btn.innerText = '‚ùå Repeat Off';
        btn.classList.replace('bg-indigo-500', 'bg-gray-300');
        btn.classList.replace('text-white', 'text-gray-800');
      }
    }


    
function obtenerLetraDesdeAppScript() {
  const song = songs[currentTrack];
  const title = (song?.title || '').replace(/^\\d+\\s*/, '');
  const artist = song?.artist || '';

  if (!title || !artist) {
    alert('Faltan datos para buscar la letra.');
    return;
  }

  const queryUrl = 'https://script.google.com/macros/s/AKfycbxXTwmC8-KY1bYIki7EAtsgM7rCvTb0Ej4qK5oeQIXcJMM4DJEDqPCliJ47eMJpN43SJA/exec' +
    '?title=' + encodeURIComponent(title) +
    '&artist=' + encodeURIComponent(artist);

  fetch(queryUrl)
    .then(res => res.text())
    .then(lyric => {
      const div = document.getElementById('letraCancion');
const letraTexto = document.getElementById('letraTexto');
letraTexto.textContent = lyric;
div.classList.remove('hidden');

    })
    .catch(err => {
      console.error(err);
      alert('Error al buscar la letra');
    });
}

</script>

<script>
function uploadToDrive() {
  const fileInput = document.getElementById('uploader');
  const file = fileInput.files[0];
  if (!file) return alert('Selecciona un archivo');

  const reader = new FileReader();
  reader.onloadend = () => {
    const base64 = reader.result.split(',')[1];
    const form = new FormData();
    form.append('file', base64);
    form.append('name', file.name);
    form.append('mimeType', file.type);

    fetch('https://script.google.com/macros/s/AKfycbx6z96Chi3PZU9ty9-5uP6RqnyzVXK0nPPxqHjuKRWccGI9LOh8anyKrP_iCRsQ25akUg/exec', {
      method: 'POST',
      body: form,
    })
    .then(res => res.text())
    .then(text => {
      document.getElementById('resultado').textContent = text;
      fileInput.value = ""; // ‚úÖ ahora se limpia correctamente
    })
    .catch(err => {
  console.error(err);
  document.getElementById('resultado').textContent = '‚ùå Error al subir: ' + err.message;
});

  };
  reader.readAsDataURL(file);
}



    const dropZone = document.getElementById("dropZone");
const uploader = document.getElementById("uploader");

// üëá Aqu√≠ a√±ades esto:
uploader.addEventListener("change", () => {
  if (uploader.files.length > 0) {
    document.getElementById("resultado").textContent = "üì§ Subiendo archivo...";
    uploadToDrive();
  }
});

dropZone.addEventListener("click", () => uploader.click());

dropZone.addEventListener("dragover", e => {
  e.preventDefault();
  dropZone.style.background = "#ddd6fe";
});
dropZone.addEventListener("dragleave", () => {
  dropZone.style.background = "";
});
dropZone.addEventListener("drop", e => {
  e.preventDefault();
  dropZone.style.background = "";
  if (e.dataTransfer.files.length) {
    uploader.files = e.dataTransfer.files;
    document.getElementById("resultado").textContent = "üì§ Preparando archivo...";
    setTimeout(() => {
      uploadToDrive();
    }, 200);
  }
});




</script>

       
        <!-- Scripts necesarios (Quill y funcionalidad) Stories -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
<script>
     const GOOGLE_APPS_SCRIPT_URL_STORIES = 'https://script.google.com/macros/s/AKfycbxlsi6XOluJVVmmZ-qwAN_1QlEPg-6qEuaBSKoUwiMiPGHzCHY_H-QD34Fg-Ita2Bli/exec'; 

let quill;
document.addEventListener("DOMContentLoaded", () => {
  quill = new Quill('#storyEditor', { theme: 'snow' });

    document.querySelector('#storyEditor').addEventListener('paste', async function (e) {
  const clipboard = e.clipboardData;
  if (!clipboard || !clipboard.items) return;

  for (const item of clipboard.items) {
    if (item.type.indexOf('image') !== -1) {
      e.preventDefault(); // evita pegado directo
      const file = item.getAsFile();
      const reader = new FileReader();

      reader.onload = async function (event) {
        const base64 = event.target.result;

        const form = new FormData();
        form.append('action', 'subirImagen');
        form.append('imagen', base64);

        const res = await fetch(GOOGLE_APPS_SCRIPT_URL_STORIES, {
          method: 'POST',
          body: form
        });

        const data = await res.json();
        if (data.status === 'success') {
          const range = quill.getSelection();
          quill.insertEmbed(range.index, 'image', data.url);
        } else {
          alert('Error al subir la imagen: ' + data.message);
        }
      };

      reader.readAsDataURL(file);
    }
  }
});



    
  document.querySelector('[data-main-tab="stories"]').addEventListener('click', cargarHistorias);
});

function mostrarMensajeHistoria(msg, tipo) {
  const box = document.getElementById("storyMessage");
  box.className = `message-box ${tipo}`;
  box.textContent = msg;
  box.style.display = 'block';
}

function procesarVideos(html) {
  const div = document.createElement('div');
  div.innerHTML = html;

  const enlaces = div.querySelectorAll('a');
  enlaces.forEach(enlace => {
    const url = enlace.href;
    let embed;

    if (url.includes('youtube.com/watch?v=')) {
      const id = url.split('v=')[1].split('&')[0];
      embed = `<iframe width="100%" height="315" src="https://www.youtube.com/embed/${id}" frameborder="0" allowfullscreen></iframe>`;
    } else if (url.includes('youtu.be/')) {
      const id = url.split('youtu.be/')[1];
      embed = `<iframe width="100%" height="315" src="https://www.youtube.com/embed/${id}" frameborder="0" allowfullscreen></iframe>`;
    } else if (url.includes('vimeo.com/')) {
      const id = url.split('vimeo.com/')[1];
      embed = `<iframe src="https://player.vimeo.com/video/${id}" width="100%" height="315" frameborder="0" allowfullscreen></iframe>`;
    }

    if (embed) {
      const wrapper = document.createElement('div');
      wrapper.innerHTML = embed;
      enlace.parentNode.replaceChild(wrapper, enlace);
    }
  });

  return div.innerHTML;
}

    
    

function guardarHistoria() {
  const titulo = document.getElementById('storyTitle').value.trim();
  let contenido = quill.root.innerHTML;

  if (!titulo || !contenido) return mostrarMensajeHistoria("Faltan datos.", "error");

  contenido = procesarVideos(contenido); // üîÑ Inserta los iframes embebidos

  const form = new FormData();
  form.append("action", "guardarHistoria");
  form.append("titulo", titulo);
  form.append("contenido", contenido);

  fetch(GOOGLE_APPS_SCRIPT_URL_STORIES, { method: 'POST', body: form })
    .then(res => res.json())
    .then(data => {
      if (data.status === 'success') {
        mostrarMensajeHistoria("‚úÖ Guardada", "success");
        document.getElementById("storyTitle").value = "";
        quill.setContents([]);
        cargarHistorias();
      } else {
        mostrarMensajeHistoria("‚ùå Error al guardar", "error");
      }
    });
}


    

async function cargarHistorias() {
  const contenedor = document.getElementById('storyList');
  contenedor.innerHTML = '<p class="text-center text-gray-500">Cargando t√≠tulos de historias...</p>';

  try {
    const response = await fetch(`${GOOGLE_APPS_SCRIPT_URL_STORIES}?action=listarHistorias`);
    const result = await response.json();

    if (result.status === 'success') {
      contenedor.innerHTML = '';
      result.historias.forEach((historia, index) => {
        const wrapper = document.createElement('div');
        wrapper.className = 'mb-2';

        const titulo = document.createElement('div');
        titulo.className = 'entry-card p-3 text-sm bg-white shadow-sm rounded-md hover:bg-indigo-50 cursor-pointer';
        titulo.textContent = `üìò ${historia.titulo} ‚Äî ${new Date(historia.fecha).toLocaleDateString()}`;

        const contenido = document.createElement('div');
        contenido.className = 'hidden bg-white p-4 rounded-md border mt-1 prose max-w-none';
        contenido.innerHTML = `
          <p class="text-sm text-gray-500 mb-2"><strong>Publicado:</strong> ${new Date(historia.fecha).toLocaleString()}</p>
          ${historia.contenido}
        `;

        titulo.addEventListener('click', () => {
          contenido.classList.toggle('hidden');
        });

        wrapper.appendChild(titulo);
        wrapper.appendChild(contenido);
        contenedor.appendChild(wrapper);
      });
    } else {
      contenedor.innerHTML = `<p class="text-center text-gray-500">${result.message || 'No hay historias disponibles.'}</p>`;
    }
  } catch (error) {
    console.error('Error al cargar historias:', error);
    contenedor.innerHTML = '<p class="text-center text-red-500">Error al conectar con el servidor.</p>';
  }
}




    async function buscarHistorias() {
  const keyword = document.getElementById('searchKeyword').value.trim();
  const desde = document.getElementById('searchStartDate').value;
  const hasta = document.getElementById('searchEndDate').value;
  const contenedor = document.getElementById('searchStoryResults');

  contenedor.innerHTML = '<p class="text-center text-gray-500">Buscando...</p>';

  const url = `${GOOGLE_APPS_SCRIPT_URL_STORIES}?action=buscarHistorias&keyword=${encodeURIComponent(keyword)}&desde=${desde}&hasta=${hasta}`;

  try {
    const res = await fetch(url);
    const data = await res.json();

    if (data.status === 'success') {
      if (!data.historias.length) {
        contenedor.innerHTML = '<p class="text-center text-gray-500">No se encontraron historias.</p>';
        return;
      }

      contenedor.innerHTML = '';
      data.historias.forEach(historia => {
        const card = document.createElement('div');
        card.className = 'entry-card mb-4';
        card.innerHTML = `
          <h4 class='font-bold text-indigo-600'>${historia.titulo}</h4>
          <p class='text-sm text-gray-500'>${new Date(historia.fecha).toLocaleString()}</p>
          <div class='prose max-w-none mt-2 bg-white p-4 rounded-md shadow-sm border'>${historia.contenido}</div>
        `;
        contenedor.appendChild(card);
      });
    } else {
      contenedor.innerHTML = `<p class="text-center text-red-500">${data.message || 'Error al buscar.'}</p>`;
    }
  } catch (error) {
    console.error('Error al buscar historias:', error);
    contenedor.innerHTML = '<p class="text-center text-red-500">Error al conectar con el servidor.</p>';
  }
}




    
</script>



</body>
</html>
