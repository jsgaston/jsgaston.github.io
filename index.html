<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mi Web Completa</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 0; background: #f5f5f5; }
    nav { background: #333; color: white; display: flex; gap: 10px; padding: 10px; }
    nav button { background: #444; border: none; color: white; padding: 10px 20px; cursor: pointer; }
    .section { display: none; padding: 20px; }
    .section.active { display: block; }
    .highlight { background: #dff0d8; padding: 10px; margin-top: 10px; border-left: 5px solid green; }
    #map { height: 400px; }
    .controls { margin: 10px 0; }
    .controls button { margin-right: 8px; }
    .song-list { margin-top: 15px; }
    .song-list li { cursor: pointer; }
    #startButton {
      background: url('https://upload.wikimedia.org/wikipedia/commons/thumb/f/fb/Green_Light_Icon.svg/1024px-Green_Light_Icon.svg.png') no-repeat center center;
      background-size: contain;
      width: 40px;
      height: 40px;
      border: none;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <nav>
    <button onclick="showSection('home')">Inicio</button>
    <button onclick="showSection('radio')">Radio</button>
    <button onclick="showSection('diario')">Diario</button>
    <button onclick="showSection('mapa')">Mapa</button>
  </nav>

  <div id="home" class="section active">
    <h2>Bienvenido</h2>
    <div id="latestEntryHome">Cargando √∫ltima entrada...</div>
  </div>

  <div id="radio" class="section">
    <h2>üéß Radio</h2>
    <div id="nowPlaying">
      <strong>Sonando:</strong> <span id="currentSong">---</span><br>
      <strong>A continuaci√≥n:</strong> <span id="nextSong">---</span>
    </div>
    <div class="controls">
      <button id="startButton" onclick="startRadio()"></button>
      <button onclick="prevTrack()">‚èÆÔ∏è</button>
      <button onclick="nextTrack()">‚è≠Ô∏è</button>
      <button onclick="toggleRepeat()">üîÅ</button>
      <button onclick="toggleRandom()">üîÄ</button>
      <button onclick="toggleList()">üéµ list</button>
    </div>
    <audio id="audio" controls></audio>
    <canvas id="visualizer" width="600" height="100" style="width:100%; background:#111; display:block; margin-top:10px;"></canvas>
    <ul id="songList" class="song-list" style="display:none;"></ul>
  </div>

  <div id="diario" class="section">
    <h2>üìì Diario</h2>
    <div id="latestEntry">Cargando entrada...</div>
  </div>

  <div id="mapa" class="section">
    <h2>üó∫Ô∏è Mapa</h2>
    <div id="map"></div>
  </div>

<script>
const API_DIARIO = "https://script.google.com/macros/s/AKfycbxVmMznPpXMH5i_U5XRojZsUBSlTGVZC2kQZbX5pHjPtBXbSMw43eEVGopAYgGRz6Ei/exec";
const API_MAPS = "https://script.google.com/macros/s/AKfycbz2SGXerStzhT2mYiKpK0JJLyrZTgrD5L_3WT-jZCK09YdE4AXfFtxkUC8j4gysAcFv/exec";

function showSection(id) {
  document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

fetch(API_DIARIO + "?action=getLatest")
  .then(r => r.json())
  .then(data => {
    document.getElementById("latestEntry").innerHTML = data.html;
    document.getElementById("latestEntryHome").innerHTML = data.html;
  });

fetch(API_MAPS)
  .then(r => r.json())
  .then(data => {
    const map = L.map('map').setView([data.lat, data.lng], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    L.marker([data.lat, data.lng]).addTo(map).bindPopup('√öltima ubicaci√≥n').openPopup();
  });

// Radio
const audio = document.getElementById('audio');
const canvas = document.getElementById('visualizer');
const ctx = canvas.getContext('2d');
let playlist = [];
let currentIndex = 0;
let repeat = false;
let random = false;
let visualStarted = false;
let audioCtx, analyser, source, bufferLength, dataArray;

function startRadio() {
  fetch("music_list.json")
    .then(res => res.json())
    .then(data => {
      playlist = data;
      loadTrack(currentIndex);
      audio.addEventListener('play', () => {
        if (!visualStarted) {
          initVisualizer();
        } else if (audioCtx?.state === 'suspended') {
          audioCtx.resume();
        }
      });
    });
}

function loadTrack(i) {
  if (!playlist.length) return;
  currentIndex = i;
  audio.src = playlist[i].url;
  audio.play().then(() => {
    document.getElementById("currentSong").textContent = playlist[i].title;
    const nextIndex = (i + 1) % playlist.length;
    document.getElementById("nextSong").textContent = playlist[nextIndex].title;
    updateSongList();
  });
}

function prevTrack() {
  currentIndex = (currentIndex - 1 + playlist.length) % playlist.length;
  loadTrack(currentIndex);
}
function nextTrack() {
  currentIndex = random ? Math.floor(Math.random() * playlist.length) : (currentIndex + 1) % playlist.length;
  loadTrack(currentIndex);
}
function toggleRepeat() { repeat = !repeat; }
function toggleRandom() { random = !random; }
function toggleList() {
  const list = document.getElementById("songList");
  list.style.display = list.style.display === "none" ? "block" : "none";
}

function updateSongList() {
  const ul = document.getElementById("songList");
  ul.innerHTML = "";
  playlist.forEach((s, i) => {
    const li = document.createElement("li");
    let prefix = i === currentIndex ? "üé∂ " : (i === (currentIndex + 1) % playlist.length ? "‚û°Ô∏è " : "");
    li.textContent = `${prefix}${s.title}`;
    li.onclick = () => loadTrack(i);
    ul.appendChild(li);
  });
}

function initVisualizer() {
  if (visualStarted) return;
  visualStarted = true;
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  analyser = audioCtx.createAnalyser();
  source = audioCtx.createMediaElementSource(audio);
  source.connect(analyser);
  analyser.connect(audioCtx.destination);
  analyser.fftSize = 256;
  bufferLength = analyser.frequencyBinCount;
  dataArray = new Uint8Array(bufferLength);
  drawVisualizer();
}

function drawVisualizer() {
  requestAnimationFrame(drawVisualizer);
  analyser.getByteFrequencyData(dataArray);
  ctx.fillStyle = '#111';
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  const barWidth = (canvas.width / bufferLength) * 2.5;
  let x = 0;
  for (let i = 0; i < bufferLength; i++) {
    const barHeight = dataArray[i] * 0.7;
    const r = 150 + barHeight / 2;
    const g = 50 + barHeight / 3;
    const b = 200;
    ctx.fillStyle = `rgb(${r},${g},${b})`;
    ctx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
    x += barWidth + 1;
  }
}

audio.addEventListener("ended", () => {
  if (repeat) {
    loadTrack(currentIndex);
  } else {
    nextTrack();
  }
});
</script>
</body>
</html>
