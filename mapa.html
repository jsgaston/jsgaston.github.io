<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Selector de Mapas Guardados</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <!-- Leaflet Draw CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(90deg, #4285f4 0%, #34a853 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
        }
        
        .description {
            font-size: 1.1rem;
            opacity: 0.9;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .content {
            display: flex;
            flex-direction: column;
            padding: 20px;
        }
        
        #map {
            height: 400px;
            width: 100%;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 2px solid #e0e0e0;
            z-index: 1;
        }
        
        .main-layout {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
        }
        
        .saved-maps-panel {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            max-height: 500px;
            overflow-y: auto;
        }
        
        .saved-maps-panel h3 {
            color: #5f6368;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .map-list {
            list-style: none;
        }
        
        .map-item {
            padding: 12px;
            margin-bottom: 10px;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 4px solid #4285f4;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .map-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-left-color: #34a853;
        }
        
        .map-name {
            font-weight: 600;
            color: #5f6368;
        }
        
        .map-date {
            font-size: 0.8rem;
            color: #9aa0a6;
        }
        
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
        }
        
        label {
            margin-bottom: 8px;
            font-weight: 600;
            color: #5f6368;
        }
        
        input, button, select {
            padding: 12px 15px;
            border-radius: 8px;
            border: 1px solid #dadce0;
            font-size: 1rem;
        }
        
        button {
            background: #4285f4;
            color: white;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        button:hover {
            background: #3367d6;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        #saveToDrive {
            background: #34a853;
        }
        
        #saveToDrive:hover {
            background: #2d8d47;
        }
        
        #loadFromDrive {
            background: #fbbc05;
        }
        
        #loadFromDrive:hover {
            background: #e6a800;
        }
        
        #clearMap {
            background: #ea4335;
        }
        
        #clearMap:hover {
            background: #d33426;
        }
        
        #refreshMaps {
            background: #9aa0a6;
        }
        
        #refreshMaps:hover {
            background: #80868b;
        }
        
        .status-panel {
            padding: 15px;
            background: #e8f0fe;
            border-radius: 10px;
            margin-top: 20px;
            border-left: 4px solid #4285f4;
        }
        
        #status {
            font-weight: 500;
            color: #5f6368;
            min-height: 24px;
        }
        
        .instructions {
            background: #fff8e1;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border-left: 4px solid #fbbc05;
        }
        
        .instructions h3 {
            color: #f57c00;
            margin-bottom: 15px;
        }
        
        .instructions ol {
            margin-left: 20px;
        }
        
        .instructions li {
            margin-bottom: 10px;
        }
        
        .config-panel {
            background: #e6f4ea;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border-left: 4px solid #34a853;
        }
        
        .config-panel h3 {
            color: #1e8e3e;
            margin-bottom: 15px;
        }
        
        footer {
            text-align: center;
            padding: 20px;
            color: #5f6368;
            font-size: 0.9rem;
            margin-top: 20px;
            border-top: 1px solid #e0e0e0;
        }
        
        @media (max-width: 968px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
            
            .controls {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 1.8rem;
            }
        }
        
        .legend {
            padding: 10px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }
        
        .legend i {
            width: 18px;
            height: 18px;
            float: left;
            margin-right: 8px;
            opacity: 0.7;
        }
        
        .empty-state {
            text-align: center;
            padding: 30px;
            color: #9aa0a6;
        }
        
        .empty-state svg {
            margin-bottom: 15px;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Selector de Mapas Guardados</h1>
            <p class="description">Visualiza y selecciona entre todos tus mapas guardados en Google Drive</p>
        </header>
        
        <div class="content">
            <div class="main-layout">
                <div class="saved-maps-panel">
                    <h3>Mapas Guardados</h3>
                    <button id="refreshMaps" style="margin-bottom: 15px;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
                            <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
                        </svg>
                        Actualizar lista
                    </button>
                    <div id="mapListContainer">
                        <div class="empty-state">
                            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                                <path d="M7 11.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 0 1h-1a.5.5 0 0 1-.5-.5zm0-5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 0 1h-1a.5.5 0 0 1-.5-.5zm0 2.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 0 1h-1a.5.5 0 0 1-.5-.5z"/>
                            </svg>
                            <p>No hay mapas guardados</p>
                            <p>Haz clic en "Actualizar lista" para buscar mapas</p>
                        </div>
                    </div>
                </div>
                
                <div>
                    <div id="map"></div>
                    
                    <div class="controls">
                        <div class="control-group">
                            <label for="fileName">Nombre del archivo:</label>
                            <input type="text" id="fileName" placeholder="mi_trayectoria.json" value="trayectoria.json">
                        </div>
                        
                        <div class="control-group">
                            <label>Acciones:</label>
                            <button id="startDrawing">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M14.778.085A.5.5 0 0 1 15 .5V8a.5.5 0 0 1-.314.464L14.5 8l.186.464-.003.001-.006.003-.023.009a12 12 0 0 1-.397.15c-.264.095-.631.223-1.047.35-.816.252-1.879.523-2.71.523-.847 0-1.548-.28-2.158-.525l-.028-.01C7.68 8.71 7.14 8.5 6.5 8.5c-.7 0-1.638.23-2.437.477A20 20 0 0 0 3 9.342V15.5a.5.5 0 0 1-1 0V.5a.5.5 0 0 1 1 0v.282c.226-.079.496-.17.79-.26C4.606.272 5.67 0 6.5 0c.84 0 1.524.277 2.121.519l.043.018C9.286.788 9.828 1 10.5 1c.7 0 1.638-.23 2.437-.477a20 20 0 0 0 1.349-.476l.019-.007.004-.002h.001"/>
                                </svg>
                                Iniciar dibujo
                            </button>
                        </div>
                        
                        <div class="control-group">
                            <label>Guardar/Cargar:</label>
                            <button id="saveToDrive">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                                    <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                                </svg>
                                Guardar en Drive
                            </button>
                            <button id="loadFromDrive">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                                    <path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"/>
                                </svg>
                                Cargar desde Drive
                            </button>
                        </div>
                        
                        <div class="control-group">
                            <label>Gestión del mapa:</label>
                            <button id="clearMap">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                                    <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                                </svg>
                                Limpiar mapa
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="config-panel">
                <h3>Configuración de Google Apps Script</h3>
                <div class="control-group">
                    <label for="scriptUrl">URL de tu Google Apps Script:</label>
                    <input type="text" id="scriptUrl" placeholder="https://script.google.com/macros/s/..." 
                           value="https://script.google.com/macros/s/AKfycbw_Xokyi39Hgci6yZQKY7omBFKTxqw2atGC5vSbppNeW3fwkcaQsGG7UEzgWlZX0isLg/exec">
                    <small>Esta URL ya está preconfigurada con la que proporcionaste</small>
                </div>
                <button id="testScript">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M6 12.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 0 1h-3a.5.5 0 0 1-.5-.5ZM3 8.062C3 6.76 4.235 5.765 5.53 5.886a26.58 26.58 极速快3 0 0 0 4.94 0C11.765 5.765 13 6.76 13 极速快3.062v1.157a.933.933 0 0 1-.765.935c-.845.147-2.34.346-4.235.346-1.895 0-3.39-.2-4.235-.346A.933.933 0 0 1 3 9.219V8.062Zm4.542-.827a.25.25 0 0 0-.极速快3.068l-.92.9a24.767 24.767 0 0 1-1.871-.183.25.25 0 0 0-.068.495c.55.076 1.232.149 2.02.193a.25.25 0 0 0 .189-.071l.754-.736.847 1.71a.25.25 0 0 0 .404.062l.932-.97a25.286 25.286 0 0 0 1.922-.188.25.25 极速快3 0 0 0-.068-.495c-.538.074-1.207.145-1.98.189a.25.25 0 0 0-.166.076l-.754.785-.842-1.7a.25.25 0 0 0-.182-.135Z"/>
                        <path d="M8.5 1.866a1 1 0 1 0-1 0V3h-2A4.5 4.5 0 0 0 1 7.5V8a1 1 0 0 0-1 1v2a1 1 0 0 极速快3 1 1v1a2 2 极速快3 0 0 2 2h10a2 2 0 0 0 2-2v-1a1 1 0 0 0 1-1V9a1 1 0 0 0-1-1v-.5A4.5 4.5 0 0 0 10.5 3h-2V1.866ZM14 7.5V13a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V7.5A3.5 3.5 0 0 1 5.极速快3 4h5A3.5 3.5 0 0 1 14 7.5Z"/>
                    </svg>
                    Probar conexión con el Script
                </button>
                <div id="connectionResult"></div>
            </div>
            
            <div class="status-panel">
                <h3>Estado del sistema:</h3>
                <p id="status">Listo para usar. Haz clic en "Iniciar dibujo" para comenzar.</p>
            </div>
            
            <div class="instructions">
                <h3>Instrucciones de uso:</h3>
                <ol>
                    <li>Haz clic en "Actualizar lista" para ver todos tus mapas guardados en Google Drive</li>
                    <li>Selecciona un mapa de la lista para cargarlo en el visor</li>
                    <li>Usa "Iniciar dibujo" para crear nuevas trayectorias</li>
                    <li>Guarda tus nuevos mapas con "Guardar en Drive"</li>
                    <li>Puedes cargar un mapa específico por nombre usando "Cargar desde Drive"</li>
                </ol>
            </div>
        </div>
        
        <footer>
            <p>© 2023 Selector de Mapas con OpenStreetMap y Google Drive | Leaflet | OpenStreetMap contributors</p>
        </footer>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <!-- Leaflet Draw JS -->
    <script src="极速快3https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    
    <script>
        // Variables globales
        let map;
        let drawnItems;
        let drawControl;
        let scriptUrl = "";
        
        // Inicializar el mapa
        function initMap() {
            // Crear mapa centrado en una ubicación por defecto
            map = L.map('map').setView([36.8, 5.75], 10);
            
            // Añadir capa de OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            
            // Inicializar la capa para elementos dibujados
            drawnItems = new L.FeatureGroup();
            map.addLayer(drawnItems);
            
            // Establecer la URL del script
            document.getElementById('scriptUrl').value = "https://script.google.com/macros/s/AKfycbzp8x5LYXDqn5pQEq6bkwi_o9Qok4hYaFntzjDDxI2Ymd38GhuDzjPclcOEj9Y9p7tLBg/exec";
        }
        
        // Cargar la lista de mapas guardados
        async function loadSavedMapsList() {
            scriptUrl = document.getElementById('scriptUrl').value;
            
            if (!scriptUrl) {
                updateStatus('Error: Introduce la URL de tu Google Apps Script.');
                return;
            }
            
            updateStatus('Cargando lista de mapas...');
            
            try {
                // Usar un proxy para evitar problemas de CORS
                const proxyUrl = 'https://corsproxy.io/?';
                const fullUrl = proxyUrl + encodeURIComponent(`${scriptUrl}?action=list`);
                
                const response = await fetch(fullUrl);
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.result === 'success' && data.files && data.files.length > 0) {
                        displayMapsList(data.files);
                        updateStatus('✅ Lista de mapas cargada correctamente');
                    } else {
                        displayEmptyState();
                        updateStatus('No se encontraron mapas guardados');
                    }
                } else {
                    displayEmptyState();
                    updateStatus('Error al cargar la lista de mapas');
                }
            } catch (error) {
                console.error('Error:', error);
                displayEmptyState();
                updateStatus('Error de conexión al cargar la lista de mapas');
            }
        }
        
        // Mostrar la lista de mapas en el panel
        function displayMapsList(maps) {
            const mapListContainer = document.getElementById('mapListContainer');
            
            // Ordenar mapas por fecha (más recientes primero)
            maps.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            let html = '<ul class="map-list">';
            
            maps.forEach(mapItem => {
                const date = new Date(mapItem.date).toLocaleDateString();
                
                html += `
                    <li class="map-item" data-filename="${mapItem.name}">
                        <div>
                            <div class="map-name">${mapItem.name}</div>
                            <div class="map-date">${date}</div>
                        </div>
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path fill-rule="evenodd" d="M10.854 8.146a.5.5 0 0 1 0 .708l-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L7.5 10.793l2.646-2.647a.5.5 0 0 1 .708 0z"/>
                            <path d="M8 1a2.5 2.5 0 0 1 2.5 2.5V4h-5v-.5A2.5 2.5 0 0 1 8 1zm3.5 3v-.5a3.5 3.5 0 1 0-7 0V4H1v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V4h-3.5zM2 5h12v9a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V5z"/>
                        </svg>
                    </li>
                `;
            });
            
            html += '</ul>';
            mapListContainer.innerHTML = html;
            
            // Añadir event listeners a los elementos de la lista
            document.querySelectorAll('.map-item').forEach(item => {
                item.addEventListener('click', function() {
                    const fileName = this.getAttribute('data-filename');
                    document.getElementById('fileName').value = fileName;
                    loadSelectedMap(fileName);
                });
            });
        }
        
        // Mostrar estado vacío
        function displayEmptyState() {
            const mapListContainer = document.getElementById('mapListContainer');
            mapListContainer.innerHTML = `
                <div class="empty-state">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M8 15A7 7 极速快3 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                        <path d="M7 11.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 0 1极速快3h-1a.5.5 0 0 1-.5-.5zm0-5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 0 1h-1a.5.5 0 0 1-.5-.5zm0 2.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 0 1h-1a.5.5 0 0 1-.5-.5z"/>
                    </svg>
                    <p>No hay mapas guardados</p>
                    <p>Guarda algún mapa primero</p>
                </div>
            `;
        }
        
        // Cargar un mapa seleccionado
        function loadSelectedMap(fileName) {
            document.getElementById('fileName').value = fileName;
            loadFromDrive();
        }
        



        let map;
        let drawnItems;
        let drawControl;
        let scriptUrl = "";
        
        // Inicializar el mapa
        function initMap() {
            // Crear mapa centrado en una ubicación por defecto
            map = L.map('map').setView([36.8, 5.75], 10); // Centro en Argelia
            
            // Añadir capa de OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            
            // Inicializar la capa para elementos dibujados
            drawnItems = new L.FeatureGroup();
            map.addLayer(drawnItems);
            
            // Añadir leyenda
            const legend = L.control({position: 'bottomright'});
            legend.onAdd = function(map) {
                const div = L.DomUtil.create('div', 'legend');
                div.innerHTML = '<h4>Leyenda</h4>';
                div.innerHTML += '<i style="background: #3388ff"></i> Línea<br>';
                div.innerHTML += '<i style="background: #fa5e4a"></i> Polígono<br>';
                div.innerHTML += '<i style="background: #4af55c"></i> Marcador';
                return div;
            };
            legend.addTo(map);
            
            // Establecer la URL del script
            document.getElementById('scriptUrl').value = "https://script.google.com/macros/s/AKfycbzp8x5LYXDqn5pQEq6bkwi_o9Qok4hYaFntzjDDxI2Ymd38GhuDzjPclcOEj9Y9p7tLBg/exec";
        }
        
        // Iniciar el modo de dibujo
        function startDrawing() {
            // Si ya existe un control de dibujo, lo eliminamos
            if (drawControl) {
                map.removeControl(drawControl);
            }
            
            // Configurar opciones de dibujo
            drawControl = new L.Control.Draw({
                edit: {
                    featureGroup: drawnItems
                },
                draw: {
                    polygon: {
                        shapeOptions: {
                            color: '#fa5e4a'
                        }
                    },
                    polyline: {
                        shapeOptions: {
                            color: '#3388ff'
                        }
                    },
                    rectangle: false,
                    circle: false,
                    marker: {
                        icon: new L.Icon({
                            iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon.png',
                            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
                            iconSize: [25, 41],
                            iconAnchor: [12, 41]
                        })
                    },
                    circlemarker: false
                }
            });
            
            // Añadir control de dibujo al mapa
            map.addControl(drawControl);
            
            // Eventos para capturar lo dibujado
            map.on(L.Draw.Event.CREATED, function (e) {
                const type = e.layerType;
                const layer = e.layer;
                
                // Añadir la capa al grupo
                drawnItems.addLayer(layer);
                
                updateStatus('Elemento dibujado correctamente. Continúa dibujando o guarda tu trabajo.');
            });
            
            updateStatus('Modo dibujo activado. Usa las herramientas en la esquina superior derecha.');
        }
        
        // Guardar datos en Google Drive
        async function saveToDrive() {
            // Convertir los elementos dibujados a GeoJSON
            const data = drawnItems.toGeoJSON();
            
            if (Object.keys(data.features).length === 0) {
                updateStatus('Error: No hay datos para guardar. Dibuja algo en el mapa primero.');
                return;
            }
            
            const fileName = document.getElementById('fileName').value || 'trayectoria.json';
            scriptUrl = document.getElementById('scriptUrl').value;
            
            if (!scriptUrl) {
                updateStatus('Error: Introduce la URL de tu Google Apps Script.');
                return;
            }
            
            updateStatus('Guardando en Google Drive...');
            debugLog('Iniciando guardado en Drive...');
            debugLog('URL del script: ' + scriptUrl);
            debugLog('Nombre de archivo: ' + fileName);
            
            try {
                // Usar un proxy para evitar problemas de CORS
                const proxyUrl = 'https://corsproxy.io/?';
                const fullUrl = proxyUrl + encodeURIComponent(scriptUrl);
                
                debugLog('Usando proxy CORS: ' + fullUrl);
                
                const response = await fetch(fullUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'save',
                        filename: fileName,
                        data: data
                    })
                });
                
                debugLog('Respuesta recibida. Estado: ' + response.status);
                
                if (response.ok) {
                    const result = await response.json();
                    debugLog('Resultado: ' + JSON.stringify(result));
                    
                    if (result.result === 'success') {
                        updateStatus('✅ Datos guardados correctamente en Google Drive. ID: ' + result.id);
                    } else {
                        updateStatus('Error: ' + result.error);
                    }
                } else {
                    const errorText = await response.text();
                    debugLog('Error del servidor: ' + errorText);
                    updateStatus('Error al guardar. Código de estado: ' + response.status);
                    
                    // Intentar con simulación
                    simulateSave(fileName, data);
                }
            } catch (error) {
                console.error('Error:', error);
                debugLog('Excepción: ' + error.toString());
                updateStatus('Error de conexión. Probando en modo simulación...');
                
                // Intentar con simulación
                simulateSave(fileName, data);
            }
        }
        
        // Simular guardado (para cuando hay problemas con el script)
        function simulateSave(fileName, data) {
            debugLog('Iniciando simulación de guardado...');
            
            try {
                // Guardar en localStorage para simular persistencia
                localStorage.setItem('simulated_drive_data', JSON.stringify(data));
                localStorage.setItem('simulated_drive_filename', fileName);
                
                setTimeout(() => {
                    updateStatus('✅ Simulación: Datos guardados correctamente. Nombre: ' + fileName);
                    debugLog('Simulación completada correctamente.');
                }, 1000);
            } catch (e) {
                updateStatus('Error incluso en simulación: ' + e.toString());
                debugLog('Error en simulación: ' + e.toString());
            }
        }
        
        // Cargar datos desde Google Drive
        async function loadFromDrive() {
            const fileName = document.getElementById('fileName').value || 'trayectoria.json';
            scriptUrl = document.getElementById('scriptUrl').value;
            
            if (!scriptUrl) {
                updateStatus('Error: Introduce la URL de tu Google Apps Script.');
                return;
            }
            
            updateStatus('Cargando desde Google Drive...');
            debugLog('Iniciando carga desde Drive...');
            
            try {
                // Usar un proxy para evitar problemas de CORS
                const proxyUrl = 'https://corsproxy.io/?';
                const fullUrl = proxyUrl + encodeURIComponent(`${scriptUrl}?action=load&filename=${encodeURIComponent(fileName)}`);
                
                debugLog('URL de carga: ' + fullUrl);
                
                const response = await fetch(fullUrl);
                debugLog('Respuesta recibida. Estado: ' + response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    debugLog('Datos recibidos: ' + JSON.stringify(data).substring(0, 200) + '...');
                    
                    // Limpiar elementos existentes
                    drawnItems.clearLayers();
                    
                    // Añadir los elementos cargados al mapa
                    L.geoJSON(data).addTo(drawnItems);
                    
                    // Ajustar la vista del mapa a los elementos cargados
                    map.fitBounds(drawnItems.getBounds());
                    
                    updateStatus('✅ Datos cargados correctamente desde Google Drive.');
                } else {
                    const errorText = await response.text();
                    debugLog('Error del servidor: ' + errorText);
                    updateStatus('Error al cargar. Probando en modo simulación...');
                    
                    // Intentar con simulación
                    simulateLoad(fileName);
                }
            } catch (error) {
                console.error('Error:', error);
                debugLog('Excepción: ' + error.toString());
                updateStatus('Error de conexión. Probando en modo simulación...');
                
                // Intentar con simulación
                simulateLoad(fileName);
            }
        }
        
        // Simular carga (para cuando hay problemas con el script)
        function simulateLoad(fileName) {
            debugLog('Iniciando simulación de carga...');
            
            try {
                const simulatedData = localStorage.getItem('simulated_drive_data');
                const simulatedFilename = localStorage.getItem('simulated_drive_filename');
                
                if (simulatedData && simulatedFilename === fileName) {
                    const data = JSON.parse(simulatedData);
                    
                    // Limpiar elementos existentes
                    drawnItems.clearLayers();
                    
                    // Añadir los elementos cargados al mapa
                    L.geoJSON(data).addTo(drawnItems);
                    
                    // Ajustar la vista del mapa a los elementos cargados
                    map.fitBounds(drawnItems.getBounds());
                    
                    updateStatus('✅ Simulación: Datos cargados correctamente desde almacenamiento local.');
                    debugLog('Simulación de carga completada.');
                } else {
                    updateStatus('Error en simulación: No hay datos guardados con el nombre: ' + fileName);
                    debugLog('No se encontraron datos simulados para: ' + fileName);
                }
            } catch (e) {
                updateStatus('Error incluso en simulación: ' + e.toString());
                debugLog('Error en simulación de carga: ' + e.toString());
            }
        }
        
        // Probar la conexión con el script
        async function testScriptConnection() {
            scriptUrl = document.getElementById('scriptUrl').value;
            
            if (!scriptUrl) {
                updateStatus('Por favor, introduce la URL de tu Google Apps Script.');
                return;
            }
            
            updateStatus('Probando conexión con el script...');
            debugLog('Probando conexión con: ' + scriptUrl);
            
            const connectionResult = document.getElementById('connectionResult');
            connectionResult.innerHTML = '';
            
            try {
                // Usar un proxy para evitar problemas de CORS
                const proxyUrl = 'https://corsproxy.io/?';
                const fullUrl = proxyUrl + encodeURIComponent(scriptUrl + '?action=test');
                
                debugLog('URL de prueba: ' + fullUrl);
                
                const response = await fetch(fullUrl);
                debugLog('Respuesta de prueba. Estado: ' + response.status);
                
                if (response.ok) {
                    const result = await response.json();
                    debugLog('Resultado de prueba: ' + JSON.stringify(result));
                    
                    if (result.result === 'success') {
                        connectionResult.innerHTML = '<div class="success-message">✅ Conexión exitosa con Google Apps Script</div>';
                        updateStatus('✅ Conexión exitosa con Google Apps Script');
                    } else {
                        connectionResult.innerHTML = '<div class="error-message">❌ Error en la conexión: ' + result.error + '</div>';
                        updateStatus('Error en la conexión: ' + result.error);
                    }
                } else {
                    const errorText = await response.text();
                    debugLog('Error en prueba: ' + errorText);
                    connectionResult.innerHTML = '<div class="error-message">❌ Error en la conexión. Código: ' + response.status + '</div>';
                    updateStatus('Error en la conexión. Código: ' + response.status);
                }
            } catch (error) {
                console.error('Error:', error);
                debugLog('Excepción en prueba: ' + error.toString());
                connectionResult.innerHTML = '<div class="error-message">❌ Error de conexión: ' + error.message + '</div>';
                updateStatus('Error de conexión: ' + error.message);
            }
        }
        
        // Limpiar el mapa
        function clearMap() {
            drawnItems.clearLayers();
            updateStatus('Mapa limpiado. Todos los elementos han sido eliminados.');
        }
        
        // Actualizar el mensaje de estado
        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }
        
        // Añadir mensaje a la consola de depuración
        function debugLog(message) {
            const debugOutput = document.getElementById('debugOutput');
            const timestamp = new Date().toLocaleTimeString();
            debugOutput.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            debugOutput.scrollTop = debugOutput.scrollHeight;
        }


                // Resto de funciones (initMap, startDrawing, saveToDrive, loadFromDrive, etc.)
        // ... (El resto del código JavaScript es similar al anterior)
        
        // Inicializar cuando se cargue la página
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            
            // Event listeners para los botones
            document.getElementById('startDrawing').addEventListener('click', startDrawing);
            document.getElementById('saveToDrive').addEventListener('click', saveToDrive);
            document.getElementById('loadFromDrive').addEventListener('click', loadFromDrive);
            document.getElementById('clearMap').addEventListener('click', clearMap);
            document.getElementById('testScript').addEventListener('click', testScriptConnection);
            document.getElementById('refreshMaps').addEventListener('click', loadSavedMapsList);
            
            // Cargar la lista de mapas al iniciar
            setTimeout(() => {
                loadSavedMapsList();
            }, 1000);
        });
        

    </script>
</body>
</html>
