<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor de Diario</title>
    <script src="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.snow.css" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.37.10/docxtemplater.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f3f4f6; 
            padding: 20px; 
            margin: 0;
        }
        .container { 
            background-color: #ffffff; 
            padding: 2.5rem; 
            border-radius: 0.75rem; 
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); 
            max-width: 100%; 
            border: 1px solid #e5e7eb; 
        }
        h1 { 
            color: #1a202c; 
            font-size: 2rem; 
            font-weight: 700; 
            margin-bottom: 1.5rem; 
            text-align: center; 
        }
        .form-label { 
            font-weight: 600; 
            margin-bottom: 8px; 
            display: block; 
            color: #374151; 
        }
        .form-input { 
            width: 100%; 
            padding: 12px; 
            border: 1px solid #d1d5db; 
            border-radius: 8px; 
            font-size: 1rem; 
            color: #1f2937; 
            background-color: #f9fafb; 
            box-sizing: border-box;
        }
        .btn { 
            background-color: #4f46e5; 
            color: white; 
            padding: 14px 24px; 
            border-radius: 8px; 
            font-weight: 600; 
            cursor: pointer; 
            transition: background-color 0.2s, transform: 0.1s; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 8px; 
            width: 100%; 
            margin-top: 1.5rem; 
            border: none;
        }
        .btn:hover { 
            transform: scale(1.02); 
            background-color: #4338ca;
        }
        .message-box { 
            padding: 12px 20px; 
            border-radius: 8px; 
            margin-top: 20px; 
            font-weight: 500; 
            display: none; 
        }
        .message-box.success { 
            background-color: #d1fae5; 
            color: #065f46; 
            border: 1px solid #10b981; 
        }
        .message-box.error { 
            background-color: #fee2e2; 
            color: #991b1b; 
            border: 1px solid #ef4444; 
        }
        .loading-spinner { 
            border: 4px solid rgba(255, 255, 255, 0.3); 
            border-top: 4px solid #ffffff; 
            border-radius: 50%; 
            width: 24px; 
            height: 24px; 
            animation: spin 1s linear infinite; 
            display: none; 
        }
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
        .story-list { 
            list-style: none; 
            padding: 0; 
        }
        .story-item { 
            background-color: #fafafa; 
            border: 1px solid #e5e7eb; 
            border-radius: 8px; 
            padding: 20px; 
            margin-bottom: 20px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); 
        }
        .story-item h3 { 
            font-size: 1.5rem; 
            font-weight: 600; 
            color: #1f2937; 
            margin-bottom: 10px; 
        }
        .story-item .header { 
            cursor: pointer; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 10px;
            border-radius: 6px;
        }
        .story-item .header:hover { 
            background-color: #f0f4f8; 
        }
        .story-item .arrow { 
            transition: transform 0.3s; 
            margin-left: 10px;
        }
        .story-item .arrow.expanded { 
            transform: rotate(90deg); 
        }
        .story-content { 
            display: none; 
            margin-top: 15px; 
            padding: 15px;
            border-top: 1px solid #e5e7eb;
        }
        .story-content.expanded { 
            display: block; 
        }
        .story-content img { 
            max-width: 100%; 
            height: auto; 
            display: block; 
            margin: 15px auto; 
            border-radius: 8px; 
        }
        
        .video-wrapper {
            position: relative;
            padding-bottom: 56.25%;
            height: 0;
            overflow: hidden;
            max-width: 100%;
            background: #000;
            margin-top: 15px;
            border-radius: 8px;
        }
        .video-wrapper iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
        }

        .video-link {
            display: block;
            margin-top: 10px;
            color: #3b82f6;
            text-decoration: underline;
            font-size: 0.9rem;
            word-break: break-all;
        }

        .tab-content { 
            display: none; 
        }
        .tab-content.active { 
            display: block; 
        }
        .btn-tab { 
            background-color: #e5e7eb; 
            color: #4b5563; 
            padding: 10px 20px; 
            border: none; 
            border-radius: 8px; 
            font-weight: 500; 
            cursor: pointer; 
            transition: background-color 0.2s; 
        }
        .btn-tab.active { 
            background-color: #4f46e5; 
            color: white; 
        }
        .download-btn { 
            background-color: #10b981; 
            margin-right: 10px; 
            width: auto;
            padding: 10px 15px;
        }
        .download-btn:hover {
            background-color: #0d966c;
        }
        #editor-container { 
            height: 300px; 
            margin-bottom: 20px; 
            border: 1px solid #d1d5db; 
            border-radius: 8px;
        }
        .download-buttons-container { 
            display: flex; 
            gap: 10px; 
            margin-top: 15px; 
            flex-wrap: wrap; 
        }
        
        /* Estilos para búsqueda avanzada */
        .search-container { 
            margin-bottom: 20px; 
            display: flex; 
            gap: 10px; 
            flex-wrap: wrap; 
        }
        .search-input { 
            flex: 1; 
            min-width: 200px; 
        }
        .search-date-group { 
            display: flex; 
            gap: 10px; 
            align-items: center; 
            flex-wrap: wrap;
        }
        .search-date-group label { 
            white-space: nowrap; 
        }
        .search-btn { 
            background-color: #3b82f6; 
            width: auto; 
        }
        .search-btn:hover {
            background-color: #2563eb;
        }
        .reset-search-btn { 
            background-color: #6b7280; 
            width: auto; 
        }
        .reset-search-btn:hover {
            background-color: #4b5563;
        }
        .no-results { 
            text-align: center; 
            padding: 20px; 
            color: #6b7280; 
            font-style: italic;
        }
        .search-advanced-toggle { 
            color: #3b82f6; 
            cursor: pointer; 
            text-decoration: underline; 
            margin-top: 10px; 
            margin-bottom: 10px;
            display: inline-block;
        }
        .search-advanced-toggle:hover {
            color: #2563eb;
        }
        .search-advanced-filters { 
            display: none; 
            margin-top: 15px; 
            padding: 15px; 
            background-color: #f9fafb; 
            border-radius: 8px; 
            border: 1px solid #e5e7eb; 
        }
        .search-advanced-filters.active { 
            display: block; 
        }
        
        /* Estilos para la carga de imágenes */
        .image-upload-progress {
            display: none;
            margin-top: 10px;
            padding: 10px;
            background-color: #f0f9ff;
            border-radius: 8px;
            border: 1px solid #bae6fd;
        }
        .progress-bar {
            height: 10px;
            background-color: #e5e7eb;
            border-radius: 5px;
            overflow: hidden;
            margin-top: 5px;
        }
        .progress-bar-inner {
            height: 100%;
            background-color: #3b82f6;
            width: 0%;
            transition: width 0.3s;
        }
        
        /* Estilos para imágenes en el editor */
        .ql-editor img {
            max-width: 100%;
            height: auto;
        }
        
        /* Indicador de carga para imágenes */
        .image-loading {
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f3f4f6;
            border-radius: 8px;
            margin: 15px 0;
            color: #6b7280;
            font-style: italic;
        }
        .image-error {
            padding: 15px;
            background-color: #fee2e2;
            border: 1px solid #fecaca;
            border-radius: 8px;
            color: #b91c1c;
            margin: 15px 0;
            font-size: 0.9rem;
        }
        
        /* Mejoras visuales para el contenido */
        .story-content .ql-editor {
            font-family: 'Inter', sans-serif;
            line-height: 1.6;
        }
        .story-content p {
            margin-bottom: 1rem;
        }
        
        /* Configuración error */
        .config-error {
            background-color: #fef3f2;
            border: 1px solid #fecdca;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }
        .config-error h3 {
            color: #b42318;
            margin-top: 0;
        }
        .config-error p {
            color: #667085;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 1.5rem;
            }
            
            .search-container {
                flex-direction: column;
            }
            
            .search-date-group {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .story-item .header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .download-buttons-container {
                flex-direction: column;
            }
            
            .download-btn {
                width: 100%;
                margin-right: 0;
                margin-bottom: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Editor de entradas Diario</h1>
        <nav style="display: flex; gap: 10px; margin-bottom: 20px;">
            <button class="btn-tab active" data-tab="create">Crear Nuevo Entrada</button>
            <button class="btn-tab" data-tab="view">Ver Todos los Entradas</button>
        </nav>
        <div id="create-tab" class="tab-content active">
            <form id="cuentoForm">
                <div style="margin-bottom: 1rem;">
                    <label for="titulo" class="form-label">Título:</label>
                    <input type="text" id="titulo" name="titulo" class="form-input" required>
                </div>
                <div style="margin-bottom: 1rem;">
                    <label class="form-label">Contenido:</label>
                    <div id="editor-container"></div>
                </div>
                <div id="imageUploadProgress" class="image-upload-progress">
                    <p>Subiendo imágenes: <span id="uploadStatus">0/0</span></p>
                    <div class="progress-bar">
                        <div class="progress-bar-inner" id="progressBar"></div>
                    </div>
                </div>
                <button type="submit" class="btn">
                    <span id="buttonText">Guardar Entrada</span>
                    <div id="loadingSpinner" class="loading-spinner"></div>
                </button>
                <div id="messageBox" class="message-box"></div>
            </form>
        </div>
        <div id="view-tab" class="tab-content">
            <h2>Entradas Publicados</h2>
            
            <!-- Contenedor de búsqueda -->
            <div class="search-container">
                <input type="text" id="searchText" class="form-input search-input" placeholder="Buscar por palabra...">
                <button id="searchBtn" class="btn search-btn">Buscar</button>
                <button id="resetSearchBtn" class="btn reset-search-btn">Restablecer</button>
            </div>
            
            <div class="search-advanced-toggle" id="toggleAdvancedSearch">
                Búsqueda avanzada ▼
            </div>
            
            <div class="search-advanced-filters" id="advancedSearchFilters">
                <div style="margin-bottom: 15px;">
                    <label class="form-label">Rango de fechas:</label>
                    <div class="search-date-group">
                        <input type="date" id="searchDateStart" class="form-input">
                        <span>a</span>
                        <input type="date" id="searchDateEnd" class="form-input">
                    </div>
                </div>
                <button id="searchAdvancedBtn" class="btn search-btn">Buscar con filtros</button>
            </div>
            
            <div id="cuentos-list" class="story-list">
                <p>Cargando entradas...</p>
            </div>
        </div>
    </div>

    <script>
        // URL de Google Apps Script - Debes reemplazar esto con tu URL correcta
        const APP_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxMkCdjnh-HJuUj7w_tXnpGHlD9ol-rciqZn7LyJQGaHRRWe7k3OkC7_CkFHJ1Pe-Catw/exec'; 

        // Inicializar Quill
        const quill = new Quill('#editor-container', {
            theme: 'snow',
            placeholder: 'Escribe tu historia aquí...',
            modules: {
                toolbar: [
                    ['bold', 'italic', 'underline', 'strike'],
                    ['blockquote', 'code-block'],
                    [{ 'header': 1 }, { 'header': 2 }],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    [{ 'script': 'sub'}, { 'script': 'super' }],
                    [{ 'indent': '-1'}, { 'indent': '+1' }],
                    [{ 'direction': 'rtl' }],
                    [{ 'size': ['small', false, 'large', 'huge'] }],
                    [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
                    [{ 'color': [] }, { 'background': [] }],
                    [{ 'font': [] }],
                    [{ 'align': [] }],
                    ['link', 'image', 'video'],
                    ['clean']
                ]
            }
        });

        // Variables globales para almacenar los cuentos y búsqueda
        let allCuentos = [];
        let filteredCuentos = [];

        // Función para mostrar mensajes
        function showMessage(type, message) {
            const messageBox = document.getElementById('messageBox');
            messageBox.textContent = message;
            messageBox.className = 'message-box ' + type;
            messageBox.style.display = 'block';
            
            // Ocultar mensaje después de 5 segundos
            setTimeout(() => {
                messageBox.style.display = 'none';
            }, 5000);
        }

        // Función para mostrar error de configuración
        function showConfigError(message) {
            const cuentosList = document.getElementById('cuentos-list');
            cuentosList.innerHTML = `
                <div class="config-error">
                    <h3>Error de Configuración</h3>
                    <p>${message}</p>
                    <p>Por favor, verifica que el Google Apps Script esté correctamente configurado y publicado.</p>
                </div>
            `;
        }

        // Función para cargar entradas
        function cargarCuentos() {
            const cuentosList = document.getElementById('cuentos-list');
            cuentosList.innerHTML = '<p>Cargando entradas...</p>';
            
            fetch(`${APP_SCRIPT_URL}?action=listarCuentos`)
                .then(response => response.json())
                .then(result => {
                    if (result.estado === 'éxito') {
                        allCuentos = result.cuentos;
                        filteredCuentos = [...allCuentos];
                        mostrarCuentos(filteredCuentos);
                    } else {
                        showConfigError(result.mensaje || 'Error desconocido al cargar las entradas.');
                    }
                })
                .catch(error => {
                    showConfigError('No se pudo conectar con el servidor. Verifica la URL del Google Apps Script.');
                    console.error('Error al cargar:', error);
                });
        }

        // Función para mostrar entradas
        function mostrarCuentos(cuentos) {
            const cuentosList = document.getElementById('cuentos-list');
            
            if (cuentos.length === 0) {
                cuentosList.innerHTML = '<p class="no-results">No se encontraron entradas.</p>';
                return;
            }
            
            cuentosList.innerHTML = '';
            
            cuentos.forEach(cuento => {
                const storyItem = document.createElement('div');
                storyItem.className = 'story-item';
                
                const formattedDate = new Date(cuento.fecha).toLocaleDateString('es-ES', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                storyItem.innerHTML = `
                    <div class="header" onclick="toggleStoryContent(this)">
                        <h3>${cuento.titulo}</h3>
                        <div>
                            <span style="color: #6b7280; font-size: 0.9rem;">${formattedDate}</span>
                            <span class="arrow">▶</span>
                        </div>
                    </div>
                    <div class="story-content">
                        <div>${cuento.contenido}</div>
                        <div class="download-buttons-container">
                            <button class="btn download-btn" onclick="descargarPDF(${cuento.id}, '${cuento.titulo.replace(/'/g, "\\'")}', '${formattedDate}')">
                                Descargar PDF
                            </button>
                            <button class="btn download-btn" onclick="descargarWord(${cuento.id}, '${cuento.titulo.replace(/'/g, "\\'")}', '${formattedDate}')">
                                Descargar Word
                            </button>
                            <button class="btn download-btn" onclick="descargarExcel(${cuento.id}, '${cuento.titulo.replace(/'/g, "\\'")}', '${formattedDate}')">
                                Descargar Excel
                            </button>
                        </div>
                    </div>
                `;
                
                cuentosList.appendChild(storyItem);
            });
        }

        // Función para expandir/contraer contenido
        function toggleStoryContent(element) {
            const content = element.nextElementSibling;
            const arrow = element.querySelector('.arrow');
            
            if (content.style.display === 'block') {
                content.style.display = 'none';
                arrow.classList.remove('expanded');
            } else {
                content.style.display = 'block';
                arrow.classList.add('expanded');
            }
        }

        // Funciones para búsqueda y filtrado
        function buscarCuentos() {
            const searchText = document.getElementById('searchText').value.toLowerCase();
            const fechaInicio = document.getElementById('searchDateStart').value;
            const fechaFin = document.getElementById('searchDateEnd').value;
            
            // Construir parámetros de búsqueda
            let params = new URLSearchParams();
            params.append('action', 'buscarCuentos');
            
            if (searchText) {
                params.append('texto', searchText);
            }
            
            if (fechaInicio) {
                params.append('fechaInicio', fechaInicio);
            }
            
            if (fechaFin) {
                params.append('fechaFin', fechaFin);
            }
            
            const cuentosList = document.getElementById('cuentos-list');
            cuentosList.innerHTML = '<p>Buscando...</p>';
            
            fetch(`${APP_SCRIPT_URL}?${params.toString()}`)
                .then(response => response.json())
                .then(result => {
                    if (result.estado === 'éxito') {
                        filteredCuentos = result.cuentos;
                        mostrarCuentos(filteredCuentos);
                    } else {
                        showConfigError(result.mensaje || 'Error en la búsqueda.');
                    }
                })
                .catch(error => {
                    showConfigError('Error al realizar la búsqueda.');
                    console.error('Error al buscar:', error);
                });
        }

        function resetSearch() {
            document.getElementById('searchText').value = '';
            document.getElementById('searchDateStart').value = '';
            document.getElementById('searchDateEnd').value = '';
            filteredCuentos = [...allCuentos];
            mostrarCuentos(filteredCuentos);
        }

        // Funciones de descarga
        function descargarPDF(id, titulo, fecha) {
            const cuento = filteredCuentos.find(c => c.id === id);
            if (!cuento) return;
            
            // Crear un elemento temporal para obtener el texto
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = cuento.contenido;
            const textoPlano = tempDiv.textContent || tempDiv.innerText || '';
            
            // Crear PDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Título
            doc.setFontSize(20);
            doc.text(titulo, 20, 20);
            
            // Fecha
            doc.setFontSize(12);
            doc.setTextColor(100, 100, 100);
            doc.text(fecha, 20, 30);
            
            // Contenido
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            
            // Dividir el texto en líneas
            const lines = doc.splitTextToSize(textoPlano, 170);
            doc.text(lines, 20, 40);
            
            // Guardar PDF
            doc.save(`${titulo}.pdf`);
        }

        function descargarWord(id, titulo, fecha) {
            const cuento = filteredCuentos.find(c => c.id === id);
            if (!cuento) return;
            
            // Crear un documento HTML simple para Word
            const htmlContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>${titulo}</title>
                </head>
                <body>
                    <h1>${titulo}</h1>
                    <p><em>${fecha}</em></p>
                    <div>${cuento.contenido}</div>
                </body>
                </html>
            `;
            
            // Crear blob y descargar
            const blob = new Blob([htmlContent], { type: 'application/msword' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `${titulo}.doc`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function descargarExcel(id, titulo, fecha) {
            const cuento = filteredCuentos.find(c => c.id === id);
            if (!cuento) return;
            
            // Crear un elemento temporal para obtener el texto plano
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = cuento.contenido;
            const textoPlano = tempDiv.textContent || tempDiv.innerText || '';
            
            // Crear datos para Excel
            const data = [
                ['Título', titulo],
                ['Fecha', fecha],
                ['Contenido', textoPlano]
            ];
            
            // Crear libro de trabajo y hoja
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Entrada');
            
            // Ajustar el ancho de las columnas
            ws['!cols'] = [{ wch: 15 }, { wch: 50 }];
            
            // Guardar Excel
            XLSX.writeFile(wb, `${titulo}.xlsx`);
        }

        // Event listeners para búsqueda
        document.getElementById('searchBtn').addEventListener('click', buscarCuentos);
        document.getElementById('resetSearchBtn').addEventListener('click', resetSearch);
        document.getElementById('searchAdvancedBtn').addEventListener('click', buscarCuentos);
        
        // Event listener para búsqueda avanzada
        document.getElementById('toggleAdvancedSearch').addEventListener('click', function() {
            const filters = document.getElementById('advancedSearchFilters');
            const isActive = filters.classList.toggle('active');
            this.innerHTML = isActive ? 'Búsqueda avanzada ▲' : 'Búsqueda avanzada ▼';
        });

        // Event listeners para pestañas
        document.querySelectorAll('.btn-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                const tabId = this.getAttribute('data-tab');
                
                // Actualizar pestañas activas
                document.querySelectorAll('.btn-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                this.classList.add('active');
                document.getElementById(`${tabId}-tab`).classList.add('active');
                
                // Si es la pestaña de vista, cargar los cuentos
                if (tabId === 'view') {
                    cargarCuentos();
                }
            });
        });

        // Manejo del formulario
        document.getElementById('cuentoForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const titulo = document.getElementById('titulo').value;
            const contenido = document.querySelector('#editor-container .ql-editor').innerHTML;
            const buttonText = document.getElementById('buttonText');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const messageBox = document.getElementById('messageBox');
            
            buttonText.textContent = 'Guardando...';
            loadingSpinner.style.display = 'inline-block';
            messageBox.style.display = 'none';
            
            // Simular envío (debes implementar la conexión real con Google Apps Script)
            setTimeout(() => {
                showMessage('success', 'Entrada guardada correctamente (modo simulación)');
                document.getElementById('cuentoForm').reset();
                quill.setContents([]);
                
                buttonText.textContent = 'Guardar Entrada';
                loadingSpinner.style.display = 'none';
            }, 1500);
        });

        // Inicializar la aplicación
        document.addEventListener('DOMContentLoaded', function() {
            // Cargar cuentos si estamos en la pestaña de vista
            if (document.getElementById('view-tab').classList.contains('active')) {
                cargarCuentos();
            }
        });
    </script>
</body>
</html>
