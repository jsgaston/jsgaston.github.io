<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eventos Históricos - 50s Timeline</title>
    <meta name="description" content="Descubre qué eventos históricos ocurrieron en fechas como hoy hace 20, 30 y 50 años. Una ventana al pasado de España y el mundo.">
    <meta name="keywords" content="eventos históricos, historia España, acontecimientos mundiales, cronología, hoy en la historia, efemérides">

    <meta property="og:title" content="Eventos Históricos - 50s Timeline">
    <meta property="og:description" content="Explora eventos históricos que ocurrieron en fechas como hoy hace décadas">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://jsgaston.github.io/50s.html">
    <meta property="og:image" content="https://jsgaston.github.io/image_fce55e.jpg">

    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --accent-color: #4CAF50;
            --text-dark: #2c3e50;
            --text-light: #7f8c8d;
            --background-light: #f8f9fa;
            --card-shadow: 0 4px 20px rgba(0,0,0,0.1);
            --border-radius: 12px;
            --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            font-family: var(--font-family);
            line-height: 1.6;
            margin: 0;
            padding: 0;
            background-color: var(--background-light);
            color: var(--text-dark);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        header {
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 1.5rem 0;
            text-align: center;
            box-shadow: var(--card-shadow);
        }

        header h1 {
            margin: 0;
            font-size: 2.5em;
        }

        header p {
            font-size: 1.1em;
            margin-top: 0.5rem;
            opacity: 0.9;
        }

        main {
            flex: 1;
            padding: 2rem;
            max-width: 1200px;
            margin: 2rem auto;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
        }

        #date-selector-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
            padding: 1rem;
            background-color: #f0f4f8;
            border-radius: var(--border-radius);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }

        #date-selector-container label {
            font-weight: bold;
            color: var(--primary-color);
        }

        #date-input {
            padding: 0.75rem 1rem;
            border: 2px solid var(--primary-color);
            border-radius: 8px;
            font-size: 1em;
            color: var(--text-dark);
            outline: none;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            flex-grow: 1;
            max-width: 250px;
        }

        #date-input:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.2);
        }

        #search-button {
            padding: 0.75rem 1.5rem;
            background: linear-gradient(to right, var(--accent-color), #388E3C);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        #search-button:hover {
            background: linear-gradient(to right, #388E3C, #2E8B57);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.15);
        }

        #search-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        #current-date {
            text-align: center;
            font-size: 1.8em;
            color: var(--primary-color);
            margin-bottom: 2rem;
            font-weight: bold;
        }

        .timeline-section {
            margin-bottom: 3rem;
            border-left: 4px solid var(--accent-color);
            padding-left: 1.5rem;
        }

        .timeline-section h2 {
            color: var(--primary-color);
            margin-top: 0;
            margin-bottom: 1.5rem;
            font-size: 1.8em;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 0.5rem;
            display: inline-block;
        }

        .event-card {
            background-color: #ffffff;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            margin-bottom: 1.2rem;
            padding: 1.5rem;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            position: relative;
            overflow: hidden;
            border: 1px solid #e0e0e0;
        }

        .event-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 25px rgba(0,0,0,0.15);
        }

        .event-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 5px;
            height: 100%;
            background: linear-gradient(to bottom, var(--primary-color), var(--secondary-color));
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
        }

        .event-card:hover::before {
            transform: translateX(0);
        }

        .event-card h3 {
            margin-top: 0;
            color: var(--primary-color);
            font-size: 1.4em;
            margin-bottom: 0.8rem;
        }

        .event-card p {
            margin-bottom: 0.5rem;
            color: var(--text-dark);
        }

        .event-meta {
            font-size: 0.9em;
            color: var(--text-light);
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 1rem;
            border-top: 1px dashed #eee;
            padding-top: 0.8rem;
        }

        .event-meta span {
            background-color: #f0f0f0;
            padding: 5px 10px;
            border-radius: 6px;
            font-weight: 500;
        }

        .event-meta span strong {
            color: var(--primary-color);
        }

        .event-source a {
            color: var(--accent-color);
            text-decoration: none;
            font-weight: bold;
            transition: color 0.2s;
        }

        .event-source a:hover {
            color: #388E3C;
            text-decoration: underline;
        }

        .no-events {
            text-align: center;
            color: var(--text-light);
            font-style: italic;
            padding: 2rem;
            background-color: #f2f2f2;
            border-radius: var(--border-radius);
        }

        .loading-spinner, .error-message {
            text-align: center;
            padding: 2rem;
            font-size: 1.2em;
        }

        .loading-spinner {
            color: var(--primary-color);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid var(--primary-color);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            color: #D32F2F;
            background-color: #FFEBEE;
            border: 1px solid #EF9A9A;
            border-radius: var(--border-radius);
        }

        footer {
            text-align: center;
            padding: 1.5rem;
            margin-top: 2rem;
            background-color: var(--text-dark);
            color: white;
            font-size: 0.9em;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }

        footer a {
            color: white;
            text-decoration: none;
            font-weight: bold;
        }

        footer a:hover {
            text-decoration: underline;
        }

        @media (max-width: 768px) {
            header h1 {
                font-size: 2em;
            }

            main {
                padding: 1.5rem;
                margin: 1rem auto;
            }

            .timeline-section {
                padding-left: 1rem;
            }

            .timeline-section h2 {
                font-size: 1.5em;
            }

            .event-card {
                padding: 1rem;
            }

            .event-card h3 {
                font-size: 1.2em;
            }

            #date-selector-container {
                flex-direction: column;
                align-items: stretch;
            }

            #date-input {
                max-width: 100%;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>Eventos Históricos</h1>
        <p>Acontecimientos importantes que ocurrieron en fechas como hoy</p>
    </header>

    <main>
        <div id="date-selector-container">
            <label for="date-input">Seleccionar Fecha:</label>
            <input type="date" id="date-input">
            <button id="search-button">Buscar Eventos</button>
        </div>
        <div id="current-date"></div>
        <div id="events-container">
            <div class="loading-spinner">
                <div class="spinner"></div>
                Cargando eventos...
            </div>
        </div>
    </main>

    <footer>
        <p>&copy; 2025 50s Timeline. Desarrollado por <a href="https://jsgaston.github.io/" target="_blank">jsgaston.github.io</a></p>
    </footer>

    <script>
        // URL de tu Google Apps Script Web App
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwHcSmLKyLQKxJCX9TcJwZYF-7kF-z8QCv_4ZN4rwJKBuzdx3N-G1QLXz5dJwIoX0NT/exec";

        // Inicialización cuando la página carga
        document.addEventListener('DOMContentLoaded', () => {
            const dateInput = document.getElementById('date-input');
            const searchButton = document.getElementById('search-button');

            // Establecer la fecha actual por defecto
            const today = new Date();
            const year = today.getFullYear();
            const month = (today.getMonth() + 1).toString().padStart(2, '0');
            const day = today.getDate().toString().padStart(2, '0');
            dateInput.value = `${year}-${month}-${day}`;

            // Cargar eventos para la fecha actual al inicio
            fetchAndRenderEvents(dateInput.value);

            // Event listener para el botón de búsqueda
            searchButton.addEventListener('click', () => {
                fetchAndRenderEvents(dateInput.value);
            });

            // Event listener para cambios en el input de fecha
            dateInput.addEventListener('change', () => {
                fetchAndRenderEvents(dateInput.value);
            });
        });





        function fetchWithJSONP(url, callbackName) {
              return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = `${url}${url.includes('?') ? '&' : '?'}callback=${callbackName}`;
                document.body.appendChild(script);
                
                window[callbackName] = (data) => {
                  resolve(data);
                  document.body.removeChild(script);
                  delete window[callbackName];
                };
                
                script.onerror = () => {
                  reject(new Error('JSONP request failed'));
                  document.body.removeChild(script);
                  delete window[callbackName];
                };
              });
            }



async function fetchAndRenderEvents(selectedDate = null) {
    const eventsContainer = document.getElementById('events-container');
    const currentDateElement = document.getElementById('current-date');
    
    // Mostrar spinner de carga
    eventsContainer.innerHTML = `
        <div class="loading-spinner">
            <div class="spinner"></div>
            Cargando eventos...
        </div>
    `;

    try {
        // Generar un nombre de callback único para cada solicitud
        const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
        let url = `${SCRIPT_URL}?callback=${callbackName}`;
        
        if (selectedDate) {
            url += `&date=${encodeURIComponent(selectedDate)}`;
        }
        
        console.log(`🌐 Haciendo petición JSONP a: ${url}`);
        
        // Crear una promesa para manejar la respuesta JSONP
        const data = await new Promise((resolve, reject) => {
            // Configurar timeout
            const timeoutId = setTimeout(() => {
                reject(new Error('Timeout al cargar los eventos'));
                cleanup();
            }, 30000);
            
            // Función de limpieza
            const cleanup = () => {
                clearTimeout(timeoutId);
                delete window[callbackName];
                if (script.parentNode) {
                    document.body.removeChild(script);
                }
            };
            
            // Definir la función de callback global
            window[callbackName] = (response) => {
                resolve(response);
                cleanup();
            };
            
            // Crear el script para JSONP
            const script = document.createElement('script');
            script.src = url;
            
            script.onerror = () => {
                reject(new Error('Error al cargar los datos'));
                cleanup();
            };
            
            document.body.appendChild(script);
        });
        
        console.log('✅ Datos recibidos:', data);
        
        // Verificar si hay error en la respuesta
        if (data.error) {
            throw new Error(data.message || 'Error del servidor');
        }
        
        // Actualizar fecha mostrada
        currentDateElement.textContent = data.date ? 
            `Eventos del ${data.date}` : 'Eventos del día seleccionado';
        
        // Renderizar eventos
        renderEvents(data.events || []);
        
    } catch (error) {
        console.error('❌ Error al obtener eventos:', error);
        showError(error);
    }
}

function showError(error) {
    const eventsContainer = document.getElementById('events-container');
    const currentDateElement = document.getElementById('current-date');
    
    let errorMessage = 'Error desconocido';
    let techDetails = error.message;
    
    if (error.message.includes('Timeout')) {
        errorMessage = 'La petición tardó demasiado';
    } else if (error.message.includes('cargar')) {
        errorMessage = 'Error de conexión al servidor';
    }
    
    eventsContainer.innerHTML = `
        <div class="error-message">
            ❌ <strong>Error al cargar eventos históricos</strong>
            <br><br>
            <strong>Problema:</strong> ${errorMessage}
            <br>
            <small><strong>Detalles técnicos:</strong> ${techDetails}</small>
            <br><br>
            <button onclick="fetchAndRenderEvents(document.getElementById('date-input').value)" 
                    class="retry-button">
                🔄 Reintentar
            </button>
            <button onclick="testConnection()" 
                    class="test-button">
                🔧 Probar Conexión
            </button>
        </div>
    `;
    
    currentDateElement.textContent = 'Error al cargar eventos';
}

        /**
         * Renderiza los eventos en el DOM
         * @param {Array} events - Array de eventos
         */
        function renderEvents(events) {
            const eventsContainer = document.getElementById('events-container');
            eventsContainer.innerHTML = '';

            if (!events || events.length === 0) {
                eventsContainer.innerHTML = `
                    <div class="no-events">
                        📅 No se encontraron eventos históricos para la fecha seleccionada.
                        <br><small>Prueba con otra fecha o verifica que el sistema esté funcionando.</small>
                    </div>
                `;
                return;
            }

            console.log(`📊 Renderizando ${events.length} eventos`);

            // Agrupar eventos por 'CategoríaTemporal'
            const groupedEvents = events.reduce((acc, event) => {
                const category = event.CategoríaTemporal || event.CategoriaTemporall || 'Sin categoría';
                if (!acc[category]) {
                    acc[category] = [];
                }
                acc[category].push(event);
                return acc;
            }, {});

            // Orden preferido para las secciones
            const order = [
                "Hoy", 
                "Hace 11 años", 
                "Hace 22 años", 
                "Hace 26 años",
                "Hace 27 años",
                "Hace 28 años",
                "Hace 29 años",
                "Hace 32 años",
                "Hace 33 años",
                "Hace 34 años",
                "Hace 35 años",
                "Hace 36 años",
                "Hace 37 años",
                "Hace 38 años",
                "Hace 44 años", 
                "Hace 55 años", 
                "Hace 66 años"
            ];
            
            // Agregar años del 25 al 38 si no están ya
            for (let y = 25; y <= 38; y++) {
                const categoryName = `Hace ${y} años`;
                if (!order.includes(categoryName)) {
                    order.push(categoryName);
                }
            }
            
            const categoriesRendered = new Set();

            // Renderizar categorías en orden
            order.forEach(category => {
                if (groupedEvents[category] && groupedEvents[category].length > 0) {
                    renderEventSection(category, groupedEvents[category], eventsContainer);
                    categoriesRendered.add(category);
                }
            });

            // Renderizar categorías restantes
            Object.keys(groupedEvents).forEach(category => {
                if (!categoriesRendered.has(category)) {
                    renderEventSection(`Otros Eventos (${category})`, groupedEvents[category], eventsContainer);
                }
            });
        }

        /**
         * Renderiza una sección de eventos
         * @param {string} categoryTitle - Título de la categoría
         * @param {Array} events - Eventos de la categoría
         * @param {HTMLElement} container - Contenedor donde añadir la sección
         */
        function renderEventSection(categoryTitle, events, container) {
            const sectionDiv = document.createElement('div');
            sectionDiv.className = 'timeline-section';
            sectionDiv.innerHTML = `<h2>${categoryTitle} (${events.length})</h2>`;

            events.forEach(event => {
                const eventCard = document.createElement('div');
                eventCard.className = 'event-card';
                
                // Manejar diferentes posibles nombres de propiedades
                const eventTitle = event.Evento || event.evento || 'Evento sin título';
                const eventYear = event.AñoDelEvento || event.YearOfEvent || event.año || 'Año desconocido';
                const eventCountry = event.País || event.Country || event.pais || 'Desconocido';
                const eventCategory = event.Categoría || event.Category || event.categoria || 'General';
                const eventRelevance = event.Relevancia || event.Relevance || event.relevancia || 'N/A';
                const eventSource = event.Fuente || event.Source || event.fuente || 'Wikipedia';
                
                eventCard.innerHTML = `
                    <h3>${eventTitle}</h3>
                    <p><strong>Año:</strong> ${eventYear}</p>
                    <div class="event-meta">
                        <span><strong>País:</strong> ${eventCountry}</span>
                        <span><strong>Categoría:</strong> ${eventCategory}</span>
                        <span><strong>Relevancia:</strong> ${eventRelevance}/10</span>
                        ${eventSource && eventSource !== 'Wikipedia' && eventSource.startsWith('http') ? 
                            `<span class="event-source"><strong>Fuente:</strong> <a href="${eventSource}" target="_blank" rel="noopener noreferrer">Ver más</a></span>` : 
                            '<span><strong>Fuente:</strong> Wikipedia</span>'
                        }
                    </div>
                `;
                sectionDiv.appendChild(eventCard);
            });
            
            container.appendChild(sectionDiv);
        }

        /**
         * Función para probar la conexión (debugging)
         */
        function testConnection() {
            console.log('🧪 Probando conexión a:', SCRIPT_URL);
            
            fetch(SCRIPT_URL)
                .then(response => {
                    console.log('📡 Status de prueba:', response.status);
                    console.log('📋 Headers de prueba:', [...response.headers.entries()]);
                    return response.text();
                })
                .then(text => {
                    console.log('📄 Respuesta de prueba (primeros 500 caracteres):', text.substring(0, 500));
                    try {
                        const json = JSON.parse(text);
                        console.log('✅ JSON válido recibido:', json);
                        alert(`✅ Conexión exitosa!\n\nEventos encontrados: ${json.events ? json.events.length : 0}\nFecha: ${json.date || 'No especificada'}`);
                    } catch (e) {
                        console.log('❌ La respuesta no es JSON válido');
                        alert(`❌ Error: El servidor no devolvió JSON válido.\n\nRespuesta recibida: ${text.substring(0, 200)}...`);
                    }
                })
                .catch(error => {
                    console.error('❌ Prueba de conexión falló:', error);
                    alert(`❌ Error de conexión:\n\n${error.message}`);
                });
        }
    </script>
</body>
</html>
