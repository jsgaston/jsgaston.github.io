<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ACME Mapper 2.2</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, Helvetica, sans-serif;
        }
        
        body {
            background-color: #f0f0f0;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            display: grid;
            grid-template-columns: 300px 1fr;
            grid-template-rows: auto 1fr auto;
            grid-template-areas:
                "header header"
                "sidebar map"
                "footer footer";
            height: 100vh;
            gap: 0;
        }
        
        header {
            grid-area: header;
            background-color: #2c3e50;
            color: white;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 3px solid #e74c3c;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logo h1 {
            font-size: 1.8rem;
            font-weight: bold;
            color: #fff;
        }
        
        .logo span {
            color: #e74c3c;
            font-weight: bold;
        }
        
        .header-controls {
            display: flex;
            gap: 10px;
        }
        
        .header-controls button {
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .header-controls button:hover {
            background: #2980b9;
        }
        
        .sidebar {
            grid-area: sidebar;
            background-color: #ecf0f1;
            padding: 15px;
            overflow-y: auto;
            border-right: 1px solid #bdc3c7;
        }
        
        .sidebar-section {
            margin-bottom: 20px;
            background: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .sidebar-section h3 {
            font-size: 1.1rem;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e74c3c;
            color: #2c3e50;
        }
        
        .map-list {
            list-style: none;
        }
        
        .map-item {
            padding: 10px;
            margin-bottom: 8px;
            background: #f8f9fa;
            border-radius: 4px;
            border-left: 3px solid #3498db;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .map-item:hover {
            background: #e9ecef;
            border-left-color: #e74c3c;
        }
        
        .map-name {
            font-weight: bold;
            color: #2c3e50;
        }
        
        .map-date {
            font-size: 0.8rem;
            color: #7f8c8d;
        }
        
        .control-group {
            margin-bottom: 15px;
        }
        
        .control-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .control-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
        }
        
        .btn {
            display: block;
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: none;
            border-radius: 4px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            text-align: center;
            transition: background 0.2s;
        }
        
        .btn-primary {
            background: #3498db;
        }
        
        .btn-primary:hover {
            background: #2980b9;
        }
        
        .btn-success {
            background: #27ae60;
        }
        
        .btn-success:hover {
            background: #219653;
        }
        
        .btn-warning {
            background: #f39c12;
        }
        
        .btn-warning:hover {
            background: #e67e22;
        }
        
        .btn-danger {
            background: #e74c3c;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        #map {
            grid-area: map;
            height: 100%;
            z-index: 1;
        }
        
        .map-controls {
            position: absolute;
            top: 70px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 4px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.2);
        }
        
        .map-controls button {
            display: block;
            width: 100%;
            margin-bottom: 5px;
            padding: 8px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        
        footer {
            grid-area: footer;
            background-color: #2c3e50;
            color: white;
            padding: 10px 15px;
            text-align: center;
            font-size: 0.9rem;
            border-top: 3px solid #e74c3c;
        }
        
        .empty-state {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
        }
        
        .status-panel {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin-top: 15px;
            border-left: 3px solid #3498db;
            font-size: 0.9rem;
        }
        
        .acme-features {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }
        
        .feature-btn {
            padding: 8px;
            background: #2c3e50;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            text-align: center;
            font-size: 0.85rem;
        }
        
        .feature-btn:hover {
            background: #34495e;
        }
        
        /* Estilo específico para ACME Mapper */
        .acme-panel {
            background: white;
            border: 1px solid #bdc3c7;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .acme-panel h4 {
            color: #e74c3c;
            margin-bottom: 10px;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }
        
        .coordinate-input {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .coordinate-input input {
            flex: 1;
            padding: 5px;
            border: 1px solid #bdc3c7;
            border-radius: 3px;
        }
        
        @media (max-width: 968px) {
            .container {
                grid-template-columns: 1fr;
                grid-template-areas:
                    "header"
                    "map"
                    "sidebar"
                    "footer";
            }
            
            .sidebar {
                border-right: none;
                border-top: 1px solid #bdc3c7;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <h1>ACME <span>Mapper 2.2</span></h1>
            </div>
            <div class="header-controls">
                <button id="btnHelp">Ayuda</button>
                <button id="btnAbout">Acerca de</button>
            </div>
        </header>
        
        <div class="sidebar">
            <div class="sidebar-section">
                <h3>Mapas Guardados</h3>
                <button id="refreshMaps" class="btn btn-primary">Actualizar Lista</button>
                <div id="mapListContainer">
                    <div class="empty-state">
                        <p>No hay mapas guardados</p>
                        <p>Haz clic en "Actualizar lista" para buscar mapas</p>
                    </div>
                </div>
            </div>
            
            <div class="sidebar-section">
                <h3>Gestión de Mapas</h3>
                <div class="control-group">
                    <label for="fileName">Nombre del archivo:</label>
                    <input type="text" id="fileName" value="acme_map.json">
                </div>
                
                <button id="saveToDrive" class="btn btn-success">Guardar en Drive</button>
                <button id="loadFromDrive" class="btn btn-warning">Cargar desde Drive</button>
                <button id="clearMap" class="btn btn-danger">Limpiar Mapa</button>
            </div>
            
            <div class="sidebar-section">
                <h3>Herramientas de Dibujo</h3>
                <button id="startDrawing" class="btn btn-primary">Activar Dibujo</button>
                
                <div class="acme-features">
                    <button class="feature-btn">Medir Distancia</button>
                    <button class="feature-btn">Coordenadas</button>
                    <button class="feature-btn">Capas</button>
                    <button class="feature-btn">Búsqueda</button>
                </div>
            </div>
            
            <div class="acme-panel">
                <h4>Coordenadas</h4>
                <div class="coordinate-input">
                    <input type="text" placeholder="Latitud" id="inputLat">
                    <input type="text" placeholder="Longitud" id="inputLon">
                </div>
                <button class="btn btn-primary" id="btnGoTo">Ir a Coordenadas</button>
            </div>
            
            <div class="status-panel">
                <h4>Estado del Sistema</h4>
                <p id="status">Listo para usar. Haz clic en "Activar Dibujo" para comenzar.</p>
            </div>
        </div>
        
        <div id="map"></div>
        
        <div class="map-controls">
            <button id="zoomIn">+</button>
            <button id="zoomOut">-</button>
        </div>
        
        <footer>
            <p>ACME Mapper 2.2 | © 2023 ACME Corporation | Con tecnología de Leaflet y Google Apps Script</p>
        </footer>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    
    <script>
        // Variables globales
        let map;
        let drawnItems;
        let drawControl;
        let scriptUrl = "https://script.google.com/macros/s/AKfycbw4i_ARFCiXXS_kLRHHQKpU9xtVZv52tbw_gMA1LuKw85Q2ftPAtIqekW4JbhNjNMrovw/exec";
        
        // Inicializar el mapa
        function initMap() {
            // Crear mapa centrado en una ubicación por defecto
            map = L.map('map').setView([36.8, 5.75], 10);
            
            // Añadir capa base (similar a ACME Mapper)
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors | ACME Mapper'
            }).addTo(map);
            
            // Añadir capa de satélite (como ACME)
            L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
            }).addTo(map);
            
            // Inicializar la capa para elementos dibujados
            drawnItems = new L.FeatureGroup();
            map.addLayer(drawnItems);
            
            // Configurar controles de zoom
            document.getElementById('zoomIn').addEventListener('click', function() {
                map.zoomIn();
            });
            
            document.getElementById('zoomOut').addEventListener('click', function() {
                map.zoomOut();
            });
            
            // Configurar botón de coordenadas
            document.getElementById('btnGoTo').addEventListener('click', function() {
                const lat = parseFloat(document.getElementById('inputLat').value);
                const lon = parseFloat(document.getElementById('inputLon').value);
                
                if (!isNaN(lat) && !isNaN(lon)) {
                    map.setView([lat, lon], 15);
                    updateStatus(`Vista movida a coordenadas: ${lat}, ${lon}`);
                } else {
                    updateStatus('Error: Introduce coordenadas válidas');
                }
            });
            
            // Mostrar coordenadas en el movimiento del ratón
            map.on('mousemove', function(e) {
                document.getElementById('inputLat').value = e.latlng.lat.toFixed(6);
                document.getElementById('inputLon').value = e.latlng.lng.toFixed(6);
            });
        }
        
        // Cargar la lista de mapas guardados
        async function loadSavedMapsList() {
            updateStatus('Cargando lista de mapas...');
            
            try {
                // Usar un proxy para evitar problemas de CORS
                const proxyUrl = 'https://corsproxy.io/?';
                const fullUrl = proxyUrl + encodeURIComponent(`${scriptUrl}?action=list`);
                
                const response = await fetch(fullUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.result === 'success' && data.files && data.files.length > 0) {
                        displayMapsList(data.files);
                        updateStatus('Lista de mapas cargada correctamente');
                    } else {
                        displayEmptyState();
                        updateStatus('No se encontraron mapas guardados');
                    }
                } else {
                    displayEmptyState();
                    updateStatus('Error al cargar la lista de mapas');
                }
            } catch (error) {
                console.error('Error:', error);
                displayEmptyState();
                updateStatus('Error de conexión al cargar la lista de mapas');
            }
        }
        
        // Mostrar la lista de mapas en el panel
        function displayMapsList(maps) {
            const mapListContainer = document.getElementById('mapListContainer');
            
            // Ordenar mapas por fecha (más recientes primero)
            maps.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            let html = '<ul class="map-list">';
            
            maps.forEach(mapItem => {
                const date = new Date(mapItem.date).toLocaleDateString();
                const size = (mapItem.size / 1024).toFixed(2); // Tamaño en KB
                
                html += `
                    <li class="map-item" data-filename="${mapItem.name}">
                        <div class="map-name">${mapItem.name}</div>
                        <div class="map-date">${date} | ${size} KB</div>
                    </li>
                `;
            });
            
            html += '</ul>';
            mapListContainer.innerHTML = html;
            
            // Añadir event listeners a los elementos de la lista
            document.querySelectorAll('.map-item').forEach(item => {
                item.addEventListener('click', function() {
                    const fileName = this.getAttribute('data-filename');
                    document.getElementById('fileName').value = fileName;
                    loadSelectedMap(fileName);
                });
            });
        }
        
        // Mostrar estado vacío
        function displayEmptyState() {
            const mapListContainer = document.getElementById('mapListContainer');
            mapListContainer.innerHTML = `
                <div class="empty-state">
                    <p>No hay mapas guardados</p>
                    <p>Guarda algún mapa primero</p>
                </div>
            `;
        }
        
        // Cargar un mapa seleccionado
        function loadSelectedMap(fileName) {
            document.getElementById('fileName').value = fileName;
            loadFromDrive();
        }
        
        // Iniciar el modo de dibujo
        function startDrawing() {
            // Si ya existe un control de dibujo, lo eliminamos
            if (drawControl) {
                map.removeControl(drawControl);
            }
            
            // Configurar opciones de dibujo
            drawControl = new L.Control.Draw({
                edit: {
                    featureGroup: drawnItems
                },
                draw: {
                    polygon: {
                        shapeOptions: {
                            color: '#e74c3c'
                        }
                    },
                    polyline: {
                        shapeOptions: {
                            color: '#3498db'
                        }
                    },
                    rectangle: false,
                    circle: false,
                    marker: {
                        icon: new L.Icon({
                            iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon.png',
                            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
                            iconSize: [25, 41],
                            iconAnchor: [12, 41]
                        })
                    },
                    circlemarker: false
                }
            });
            
            // Añadir control de dibujo al mapa
            map.addControl(drawControl);
            
            // Eventos para capturar lo dibujado
            map.on(L.Draw.Event.CREATED, function (e) {
                const type = e.layerType;
                const layer = e.layer;
                
                // Añadir la capa al grupo
                drawnItems.addLayer(layer);
                
                updateStatus('Elemento dibujado correctamente');
            });
            
            updateStatus('Modo dibujo activado');
        }
        
        // Guardar datos en Google Drive
        async function saveToDrive() {
            // Convertir los elementos dibujados a GeoJSON
            const data = drawnItems.toGeoJSON();
            
            if (Object.keys(data.features).length === 0) {
                updateStatus('Error: No hay datos para guardar');
                return;
            }
            
            const fileName = document.getElementById('fileName').value || 'acme_map.json';
            
            updateStatus('Guardando en Google Drive...');
            
            try {
                // Usar un proxy para evitar problemas de CORS
                const proxyUrl = 'https://corsproxy.io/?';
                const fullUrl = proxyUrl + encodeURIComponent(scriptUrl);
                
                const response = await fetch(fullUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'save',
                        filename: fileName,
                        geojson: data
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    if (result.result === 'success') {
                        updateStatus('Datos guardados correctamente en Google Drive');
                        loadSavedMapsList(); // Recargar la lista
                    } else {
                        updateStatus('Error al guardar: ' + result.message);
                    }
                } else {
                    updateStatus('Error al guardar');
                }
            } catch (error) {
                console.error('Error:', error);
                updateStatus('Error de conexión al guardar en Google Drive');
            }
        }
        
        // Cargar datos desde Google Drive
        async function loadFromDrive() {
            const fileName = document.getElementById('fileName').value;
            
            if (!fileName) {
                updateStatus('Error: Introduce un nombre de archivo');
                return;
            }
            
            updateStatus('Cargando desde Google Drive...');
            
            try {
                // Usar un proxy para evitar problemas de CORS
                const proxyUrl = 'https://corsproxy.io/?';
                const fullUrl = proxyUrl + encodeURIComponent(`${scriptUrl}?action=load&filename=${encodeURIComponent(fileName)}`);
                
                const response = await fetch(fullUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    if (result.result === 'success' && result.geojson) {
                        // Limpiar el mapa actual
                        drawnItems.clearLayers();
                        
                        // Cargar el GeoJSON
                        L.geoJSON(result.geojson, {
                            onEachFeature: function (feature, layer) {
                                drawnItems.addLayer(layer);
                            }
                        });
                        
                        // Ajustar la vista del mapa a los datos cargados
                        if (drawnItems.getBounds().isValid()) {
                            map.fitBounds(drawnItems.getBounds());
                        }
                        
                        updateStatus('Mapa cargado correctamente desde Google Drive');
                    } else {
                        updateStatus('Error: No se encontró el archivo');
                    }
                } else {
                    updateStatus('Error al cargar');
                }
            } catch (error) {
                console.error('Error:', error);
                updateStatus('Error de conexión al cargar desde Google Drive');
            }
        }
        
        // Limpiar el mapa
        function clearMap() {
            drawnItems.clearLayers();
            updateStatus('Mapa limpiado');
        }
        
        // Actualizar el mensaje de estado
        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }
        
        // Inicializar la aplicación cuando se cargue el DOM
        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar el mapa
            initMap();
            
            // Configurar event listeners para los botones
            document.getElementById('startDrawing').addEventListener('click', startDrawing);
            document.getElementById('saveToDrive').addEventListener('click', saveToDrive);
            document.getElementById('loadFromDrive').addEventListener('click', loadFromDrive);
            document.getElementById('clearMap').addEventListener('click', clearMap);
            document.getElementById('refreshMaps').addEventListener('click', loadSavedMapsList);
            
            // Cargar lista inicial de mapas
            updateStatus('ACME Mapper 2.2 listo para usar');
        });
    </script>
</body>
</html>
